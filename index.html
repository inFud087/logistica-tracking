<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema Log√≠stica v20.7 - Fix Validaci√≥n OF y Buscador</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script type="module">
    // --- CONEXI√ìN FIREBASE ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    // --- ¬°CORRECCI√ìN! A√ëADIR 'where' y 'getDocs' ---
    import { 
        getFirestore, collection, onSnapshot, doc, query, where, getDocs, // <-- A√ëADIDO 'where' y 'getDocs'
        runTransaction, setDoc, enableIndexedDbPersistence 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    window.firebaseSet = setDoc;

    // Configuraci√≥n de Firebase (dejar√© la misma config que ten√≠as)
    const firebaseConfig = {
      apiKey: "AIzaSyCdjpc9vpU-YZaVxh5oAUJ78_FMbK-WtuA",
      authDomain: "erca-logistica.firebaseapp.com",
      projectId: "erca-logistica",
      storageBucket: "erca-logistica.firebasestorage.app",
      messagingSenderId: "1062081070745",
      appId: "1:1062081070745:web:454a3e5ffa8f6ca37ada08", 
      measurementId: "G-SSMFCDVYVR"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- PASO 1.2: A√ëADE ESTE BLOQUE PARA HABILITAR MODO OFFLINE ---
    try {
      await enableIndexedDbPersistence(db);
      console.log('‚úÖ Modo Offline de Firestore HABILITADO');
    } catch (err) {
      if (err.code == 'failed-precondition') {
        console.warn('‚ö†Ô∏è M√∫ltiples pesta√±as abiertas. El modo Offline solo se activa en la primera.');
      } else if (err.code == 'unimplemented') {
        console.warn('‚ö†Ô∏è El navegador no soporta el modo Offline.');
      }
    }
    // --- FIN DE LA ADICI√ìN ---

    // Exportar para uso global
    window.firebaseAuth = auth;
    window.firebaseDB = db;
    window.firebaseSignIn = signInWithEmailAndPassword;
    window.firebaseSignOut = signOut;
    window.firebaseOnAuthStateChanged = onAuthStateChanged;
    
    // FASE 3: Funciones de Firestore para Transacciones
    window.firebaseCollection = collection;
    window.firebaseOnSnapshot = onSnapshot;
    window.firebaseDoc = doc;
    window.firebaseRunTransaction = runTransaction;
    window.firebaseQuery = query;     
    window.firebaseWhere = where;     
    window.firebaseGetDocs = getDocs; 

    console.log('‚úÖ Firebase inicializado correctamente (v20.7: Fixes Cr√≠ticos)');
  </script>
  
  <style>
    /* --- ESTILOS (INALTERADO) --- */
    :root {
      --color-primary: #3b82f6;
      --color-success: #10b981;
      --color-danger: #ef4444;
      --color-warning: #f59e0b;
      --color-text: #1a1a1a;
      --color-text-secondary: #6b7280;
      --color-border: #e5e7eb;
      --color-bg: #f9fafb;
      --color-bg-card: #ffffff;
      --color-blue-accent: #3b82f6;
      --color-green-accent: #22c55e;
      --color-red-accent: #ef4444;
      --color-yellow-accent: #f59e0b;
      --color-purple-accent: #a78bfa;
    }
    [data-theme="semi-dark"] {
      --color-text: #e7e9ea;
      --color-text-secondary: #71767b;
      --color-border: #38444d;
      --color-bg: #15202b;
      --color-bg-card: #192734;
      --color-blue-accent: #60a5fa;
      --color-green-accent: #4ade80;
      --color-red-accent: #f87171;
      --color-yellow-accent: #fcd34d;
      --color-purple-accent: #c084fc;
    }
    [data-theme="dark"] {
      --color-text: #e4e6eb;
      --color-text-secondary: #8a8d91;
      --color-border: #2d2d2d;
      --color-bg: #0a0a0a;
      --color-bg-card: #1c1c1c;
      --color-blue-accent: #60a5fa;
      --color-green-accent: #4ade80;
      --color-red-accent: #f87171;
      --color-yellow-accent: #fcd34d;
      --color-purple-accent: #c084fc;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--color-bg) !important;
      color: var(--color-text);
      transition: background-color 0.3s, color 0.3s;
    }
    .card-minimal {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
    }
    .card-minimal:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    html { background-color: var(--color-bg); }
    #app { background-color: var(--color-bg); min-height: 100vh; }
    
    .bi-card {
      background-color: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 0.75rem;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .dashboard-grid {
      display: grid;
      gap: 1.25rem;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 768px) {
      .dashboard-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) {
      .dashboard-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .kpi-card { grid-column: span 1 / span 1; }
      .tendencia-card { grid-column: span 2 / span 2; }
      .estado-ordenes-card { grid-column: span 2 / span 2; }
      .ordenes-fabricacion-card { grid-column: span 2 / span 2; }
      .stock-ubicacion-card { grid-column: span 2 / span 2; }
      .actividad-card { grid-column: span 4 / span 4; }
    }
    .data-table { width: 100%; min-width: 500px; border-collapse: collapse; }
    .data-table th, .data-table td {
      padding: 0.6rem 0.8rem;
      text-align: left;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.825rem;
    }
    .data-table th {
      font-weight: 600;
      color: var(--color-text-secondary);
      white-space: nowrap;
    }
    .badge {
      padding: 0.2rem 0.6rem;
      border-radius: 9999px;
      font-weight: 500;
      font-size: 0.7rem;
      text-transform: uppercase;
    }
    .badge-in { background-color: rgba(74, 222, 128, 0.1); color: var(--color-green-accent); }
    .badge-out { background-color: rgba(248, 113, 113, 0.1); color: var(--color-red-accent); }
    .badge-transfer { background-color: rgba(167, 139, 250, 0.1); color: var(--color-purple-accent); }
    .badge-pending { background-color: rgba(251, 146, 60, 0.1); color: var(--color-yellow-accent); }
    .badge-complete { background-color: rgba(74, 222, 128, 0.1); color: var(--color-green-accent); }
    .badge-partial { background-color: rgba(59, 130, 246, 0.1); color: var(--color-blue-accent); }
    .progress-bar-container {
      background-color: var(--color-border);
      border-radius: 0.25rem;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background-color: var(--color-blue-accent);
      border-radius: 0.25rem;
      transition: width 0.3s ease-in-out;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
  const STORAGE_KEY = 'lts_store';
  const THEME_KEY = 'lts_theme';
  const CURRENT_VERSION = 3; 

  function uuid() {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
      return crypto.randomUUID();
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function now() { return new Date().toISOString(); }
  
  // =========================================================================
  // FASE 3: L√ìGICA DE FIRESTORE CON TRANSACCIONES
  // =========================================================================

  let unsubscribeFirestore = null; 
  let isInitialLoad = true;
  
  function setupFirestoreListener() {
    if (!window.firebaseDB || !window.firebaseCollection || !window.firebaseOnSnapshot) {
      console.warn('‚ö†Ô∏è Firestore no disponible para iniciar listener');
      return;
    }

    if (unsubscribeFirestore) {
      unsubscribeFirestore();
      unsubscribeFirestore = null;
      console.log('üßπ Listener de Firestore anterior cancelado.');
    }

    const collectionsToWatch = ['items', 'locations', 'inventory', 'movements', 'workOrders'];
    let fetchedData = {};
    let collectionsReady = new Set();
    
    const db = window.firebaseDB;

    console.log('üìñ Iniciando listener en tiempo real de Firestore...');

    const unsubscribes = collectionsToWatch.map(collectionName => {
      const colRef = window.firebaseCollection(db, collectionName);

      return window.firebaseOnSnapshot(colRef, { includeMetadataChanges: true }, (snapshot) => {
        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        fetchedData[collectionName] = docs;
        
        if (!collectionsReady.has(collectionName)) {
            collectionsReady.add(collectionName);
        }

        if (collectionsReady.size === collectionsToWatch.length) {
            
            const newStore = {
                schemaVersion: CURRENT_VERSION,
                items: fetchedData.items || [],
                locations: fetchedData.locations || [],
                inventory: fetchedData.inventory || [],
                movements: fetchedData.movements || [],
                users: state.store.users,
                workOrders: fetchedData.workOrders || [],
            };
            
            const totalDocs = collectionsToWatch.reduce((sum, name) => sum + newStore[name].length, 0);

            if (isInitialLoad && totalDocs > 0) {
                console.log(`‚úÖ Datos de Firestore cargados inicialmente: ${totalDocs} documentos.`);
                isInitialLoad = false;
            } else if (!isInitialLoad) {
                console.log(`üîÑ Datos de Firestore actualizados: ${totalDocs} documentos.`);
            }

            state.store = newStore;
            buildStoreMaps(state.store);
            render(); 
        }
      }, (error) => {
        console.error(`‚ùå Error en onSnapshot para ${collectionName}:`, error);
      });
    });

    unsubscribeFirestore = () => {
        unsubscribes.forEach(unsub => unsub());
        console.log('üßπ Todos los listeners de Firestore cancelados.');
    };
  }

  const Store = {
    load() {
        return this._createEmptyStore();
    },
    save(store) {
      console.warn('‚ùå Store.save(local) obsoleto. Las operaciones de negocio ahora usan Transacciones');
    },
    _createEmptyStore() {
      return {
        schemaVersion: CURRENT_VERSION,
        items: [], locations: [], inventory: [], movements: [], workOrders: [],
        users: {
          admin:   { password: 'admin123',  role: 'admin', nombre_completo: 'Administrador' },
          operario:{ password: 'oper123',   role: 'user',  nombre_completo: 'Operario 1' }
        }
      };
    },
    
    getInventory(store, itemCode, locationQR) {
      const results = [];
      let targetItemId = null;
      let targetLocationId = null;
      if (itemCode)   targetItemId = store.itemsByCode.get(itemCode)?.id;
      if (locationQR) targetLocationId = store.locationsByQr.get(locationQR)?.id;
      for (const invRow of store.inventory) {
        if (targetItemId && invRow.itemId !== targetItemId) continue;
        if (targetLocationId && invRow.locationId !== targetLocationId) continue;
        const item     = store.itemsMap.get(invRow.itemId);
        const location = store.locationsMap.get(invRow.locationId);
        if (!item || !location) continue;
        if (itemCode   && item.code   !== itemCode)   continue;
        if (locationQR && location.qr !== locationQR) continue;
        results.push({
          id: invRow.id,
          itemCode: item.code,
          itemDescription: item.description,
          locationQR: location.qr,
          locationDisplay: `${location.module}-${location.row}-${location.col}`,
          quantity: invRow.quantity
        });
      }
      return results;
    },
    getOrCreateWorkOrder(store, workOrderCode, itemCode) {
      return store.workOrders.find(w => w.code === workOrderCode);
    },

    // -------------------------------------------------------------------------
    // Helper: Upsert (Crear o actualizar)
    // -------------------------------------------------------------------------
    async upsertItemAndLocationInTransaction(transaction, itemCode, locationQR) {
        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';

        // 1. Encontrar o crear Item
        let item = state.store.itemsByCode.get(itemCode);
        let itemId = item?.id;
        if (!itemId) {
            itemId = uuid();
            const itemRef = window.firebaseDoc(db, 'items', itemId);
            transaction.set(itemRef, { code: itemCode, description: '', createdAt: now(), createdBy: username });
        }

        // 2. Encontrar o crear Location
        let location = state.store.locationsByQr.get(locationQR);
        let locationId = location?.id;
        if (!locationId) {
            locationId = uuid();
            const locationRef = window.firebaseDoc(db, 'locations', locationId);
            transaction.set(locationRef, { qr: locationQR, module: 'M?', row: 'F?', col: 'C?', createdAt: now(), createdBy: username });
        }

        return { itemId, locationId };
    },
    
    // -------------------------------------------------------------------------
    // 1. ADD STOCK (Entrada) - (¬°CORRECCI√ìN LECTURA/ESCRITURA!)
    // -------------------------------------------------------------------------
    async addStock(itemCode, locationQR, qty, workOrderCode) {
        if (qty <= 0) throw new Error('Cantidad debe ser mayor a 0');
        
        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';
        
        await window.firebaseRunTransaction(db, async (transaction) => {
            console.log('[TRANSACCION] Iniciando addStockTransaction (Corregida R/W)...');

            // --- FASE 0: PRE-C√ÅLCULO (Lectura local, no de TX) ---
            // Obtenemos IDs de la cach√© local (state.store)
            let item = state.store.itemsByCode.get(itemCode);
            let itemId = item?.id;
            let location = state.store.locationsByQr.get(locationQR);
            let locationId = location?.id;

            // Marcamos si son nuevos para crearlos en la FASE 2 (Escrituras)
            const isNewItem = !itemId;
            const isNewLocation = !locationId;
            
            if (isNewItem) itemId = uuid(); // Generamos ID para el item nuevo
            if (isNewLocation) locationId = uuid(); // Generamos ID para la ubicaci√≥n nueva

            const existingInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === locationId);
            let existingWO = null;

            // --- FASE 1: LECTURAS (TODAS ANTES DE ESCRITURAS) ---
            
            // LECTURA 1: Inventario (solo si ya existe localmente)
            let invDoc = null;
            let invRef = null;
            if (existingInv) {
                invRef = window.firebaseDoc(db, 'inventory', existingInv.id);
                invDoc = await transaction.get(invRef); // <--- LECTURA
            }

            // LECTURA 2: Work Order (si aplica)
            let woDoc = null;
            let woRef = null;
            if (workOrderCode) {
                existingWO = state.store.workOrders.find(w => w.code === workOrderCode);
                if (!existingWO) { throw new Error(`WorkOrder [${workOrderCode}] no encontrada.`); }
                
                woRef = window.firebaseDoc(db, 'workOrders', existingWO.id);
                woDoc = await transaction.get(woRef); // <--- LECTURA

                if (!woDoc.exists()) { throw new Error(`WorkOrder [${workOrderCode}] no existe en Firestore. Fallo.`); }
            }

            // --- FASE 2: ESCRITURAS (TODAS DESPU√âS DE LECTURAS) ---
            
            // ESCRITURA 1 y 2: Crear Item/Location (si eran nuevos)
            if (isNewItem) {
                const itemRef = window.firebaseDoc(db, 'items', itemId);
                transaction.set(itemRef, { code: itemCode, description: '', createdAt: now(), createdBy: username });
            }
            if (isNewLocation) {
                const locationRef = window.firebaseDoc(db, 'locations', locationId);
                transaction.set(locationRef, { qr: locationQR, module: 'M?', row: 'F?', col: 'C?', createdAt: now(), createdBy: username });
            }

            // ESCRITURA 3: Inventario
            let inventoryId;
            if (existingInv && invDoc && invDoc.exists()) {
                // Si el inventario existe, actual√≠zalo
                inventoryId = existingInv.id;
                const currentQuantity = invDoc.data().quantity || 0;
                const newQuantity = currentQuantity + qty;
                transaction.update(invRef, { quantity: newQuantity }); 
            } else {
                // Si no exist√≠a (o no estaba en Firestore), cr√©alo
                inventoryId = existingInv ? existingInv.id : uuid(); // Reutiliza ID si exist√≠a local pero no en FS
                invRef = window.firebaseDoc(db, 'inventory', inventoryId);
                transaction.set(invRef, { itemId, locationId, quantity: qty });
            }

            // ESCRITURA 4: Work Order (si aplica)
            if (workOrderCode && woDoc) { // woDoc fue le√≠do en FASE 1
                const woData = woDoc.data();
                const newProduced = (woData.quantityProduced || 0) + qty;
                
                let newStatus = woData.status;
                if (newProduced >= (woData.quantitySolicited || 0)) {
                    newStatus = 'PRODUCCION_COMPLETA';
                }
                
                transaction.update(woRef, { quantityProduced: newProduced, status: newStatus }); 
            }

            // ESCRITURA 5: Movimiento
            const movementId = uuid();
            const movementData = {
                itemCode, fromLocationQR: null, toLocationQR: locationQR,
                quantity: qty, type: 'IN', workOrderCode: workOrderCode || null,
                createdAt: now(), createdBy: username,
                clientUuid: uuid(), edited: false, editedBy: null, editedAt: null
            };
            transaction.set(window.firebaseDoc(db, 'movements', movementId), movementData); 

        }, { maxAttempts: 3 });

        console.log('‚úÖ addStockTransaction (Corregida) completada con √©xito.');
    },

    // -------------------------------------------------------------------------
    // 2. REMOVE STOCK SPLIT (Salida) - (¬°CON CORRECCI√ìN!)
    // -------------------------------------------------------------------------
    async removeStockSplit(itemCode, picks, workOrderCode) {
        if (picks.length === 0) return;

        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';
        let totalQty = 0;

        await window.firebaseRunTransaction(db, async (transaction) => {
            console.log('[TRANSACCION] Iniciando removeStockSplitTransaction...');
            
            const item = state.store.itemsByCode.get(itemCode);
            if (!item) throw new Error('Item no encontrado en el store local');
            const itemId = item.id;

            // --- FASE 1: LECTURAS ---
            let woRef = null;
            let woDoc = null;
            let existingWO = null;

            if (workOrderCode) {
                existingWO = state.store.workOrders.find(w => w.code === workOrderCode);
                if (existingWO) { 
                    woRef = window.firebaseDoc(db, 'workOrders', existingWO.id);
                    woDoc = await transaction.get(woRef); // <-- LECTURA 1
                }
            }

            const inventoryReads = [];
            for (const pick of picks) {
                const location = state.store.locationsByQr.get(pick.locationQR);
                if (!location) throw new Error(`Ubicaci√≥n [${pick.locationQR}] no encontrada en el store local`);
                
                const existingInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === location.id);
                if (!existingInv) { throw new Error(`Stock para Pieza ${itemCode} en ${pick.locationQR} no encontrado.`); }
                
                const invRef = window.firebaseDoc(db, 'inventory', existingInv.id);
                const invDoc = await transaction.get(invRef); // <-- LECTURA 2 (m√∫ltiple)
                
                if (!invDoc.exists()) { throw new Error(`Stock para Pieza ${itemCode} en ${pick.locationQR} no existe en Firestore.`); }

                inventoryReads.push({ pick, invRef, invDoc });
            }

            // --- FASE 2: ESCRITURAS ---
            for (const { pick, invRef, invDoc } of inventoryReads) {
                const currentQuantity = invDoc.data().quantity || 0;
                if (currentQuantity < pick.quantity) {
                    throw new Error(`Stock insuficiente en ${pick.locationQR}: ${currentQuantity} < ${pick.quantity}`);
                }

                const newQuantity = currentQuantity - pick.quantity;
                totalQty += pick.quantity; 

                if (newQuantity === 0) {
                    transaction.delete(invRef); // <-- ESCRITURA 1
                } else {
                    transaction.update(invRef, { quantity: newQuantity }); // <-- ESCRITURA 1
                }

                const movementId = uuid();
                const movementData = {
                    itemCode, fromLocationQR: pick.locationQR, toLocationQR: null,
                    quantity: pick.quantity, type: 'OUT', workOrderCode: workOrderCode || null,
                    createdAt: now(), createdBy: username,
                    clientUuid: uuid(), edited: false, editedBy: null, editedAt: null
                };
                transaction.set(window.firebaseDoc(db, 'movements', movementId), movementData); // <-- ESCRITURA 2
            }

            // Actualizar WorkOrder (usando el woDoc le√≠do en la FASE 1)
            if (workOrderCode && existingWO && woDoc && woDoc.exists()) {
                const woData = woDoc.data();
                const newShipped = (woData.quantityShipped || 0) + totalQty;
                
                let newStatus = woData.status;
                if (newShipped >= (woData.quantitySolicited || 0)) {
                    newStatus = 'COMPLETADA';
                } else if (newShipped > 0) {
                    if (woData.status === 'PENDIENTE' || woData.status === 'PRODUCCION_COMPLETA' || woData.status === 'ENVIO_PARCIAL') {
                         newStatus = 'ENVIO_PARCIAL';
                    }
                }
                
                transaction.update(woRef, { quantityShipped: newShipped, status: newStatus }); // <-- ESCRITURA 3
            }

        }, { maxAttempts: 3 });

        console.log('‚úÖ removeStockSplitTransaction completada con √©xito.');
    },

    // -------------------------------------------------------------------------
    // 3. TRANSFER STOCK (Traslado)
    // -------------------------------------------------------------------------
    async transferStock(itemCode, fromLocationQR, toLocationQR, qty) {
        if (qty <= 0) throw new Error('Cantidad debe ser mayor a 0');
        if (fromLocationQR === toLocationQR) throw new Error('Origen y destino no pueden ser iguales');

        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';

        await window.firebaseRunTransaction(db, async (transaction) => {
            console.log('[TRANSACCION] Iniciando transferStockTransaction...');
            
            const item = state.store.itemsByCode.get(itemCode);
            if (!item) throw new Error('Item no encontrado en el store local');
            const itemId = item.id;

            const fromLocation = state.store.locationsByQr.get(fromLocationQR);
            if (!fromLocation) throw new Error(`Ubicaci√≥n origen [${fromLocationQR}] no encontrada`);
            const fromLocationId = fromLocation.id;
            
            const { locationId: toLocationId } = await this.upsertItemAndLocationInTransaction(transaction, itemCode, toLocationQR);

            const existingFromInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === fromLocationId);
            
            if (!existingFromInv) { throw new Error(`Stock para Pieza ${itemCode} en Origen [${fromLocationQR}] no encontrado.`); }
            
            const fromInvRef = window.firebaseDoc(db, 'inventory', existingFromInv.id);
            const fromInvDoc = await transaction.get(fromInvRef);
            
            if (!fromInvDoc.exists()) { throw new Error(`Stock para Pieza ${itemCode} en Origen [${fromLocationQR}] no existe en Firestore.`); }
            
            const currentFromQty = fromInvDoc.data().quantity || 0;
            if (currentFromQty < qty) {
                throw new Error(`Stock insuficiente en Origen [${fromLocationQR}]: ${currentFromQty} < ${qty}`);
            }

            const newFromQty = currentFromQty - qty;

            if (newFromQty === 0) {
                transaction.delete(fromInvRef);
            } else {
                transaction.update(fromInvRef, { quantity: newFromQty });
            }

            const existingToInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === toLocationId);
            
            let toInventoryId;
            if (existingToInv) {
                toInventoryId = existingToInv.id;
                const toInvRef = window.firebaseDoc(db, 'inventory', toInventoryId);
                const toInvDoc = await transaction.get(toInvRef);
                
                if (!toInvDoc.exists()) {
                    toInventoryId = uuid(); 
                    transaction.set(window.firebaseDoc(db, 'inventory', toInventoryId), { itemId, locationId: toLocationId, quantity: qty });
                } else {
                    const newToQty = (toInvDoc.data().quantity || 0) + qty;
                    transaction.update(toInvRef, { quantity: newToQty });
                }
            } else {
                toInventoryId = uuid();
                transaction.set(window.firebaseDoc(db, 'inventory', toInventoryId), { itemId, locationId: toLocationId, quantity: qty });
            }

            const movementId = uuid();
            const movementData = {
                itemCode, fromLocationQR, toLocationQR,
                quantity: qty, type: 'TRANSFER', workOrderCode: null,
                createdAt: now(), createdBy: username,
                clientUuid: uuid(), edited: false, editedBy: null, editedAt: null
            };
            transaction.set(window.firebaseDoc(db, 'movements', movementId), movementData);

        }, { maxAttempts: 3 });

        console.log('‚úÖ transferStockTransaction completada con √©xito.');
    },
    
   // -------------------------------------------------------------------------
    // 4. CREAR WORK ORDER (Crear OF y registrar primera entrada) - (¬°CORRECCI√ìN R/W!)
    // -------------------------------------------------------------------------
    async createWorkOrder(pieza, orden, ubicacion, cantidad, solicitado, descripcion) {
        
        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';
        
        await window.firebaseRunTransaction(db, async (transaction) => {
            console.log('[TRANSACCION] Iniciando createWorkOrderTransaction (Corregida R/W)...');

            // --- FASE 0: PRE-C√ÅLCULO (Lectura local, no de TX) ---
            // Obtenemos IDs de la cach√© local (state.store)
            let item = state.store.itemsByCode.get(pieza);
            let itemId = item?.id;
            let location = state.store.locationsByQr.get(ubicacion);
            let locationId = location?.id;

            // Marcamos si son nuevos para crearlos en la FASE 2 (Escrituras)
            const isNewItem = !itemId;
            const isNewLocation = !locationId;
            
            if (isNewItem) itemId = uuid(); // Generamos ID para el item nuevo
            if (isNewLocation) locationId = uuid(); // Generamos ID para la ubicaci√≥n nueva

            const existingInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === locationId);
            const initialStatus = (cantidad >= solicitado) ? 'PRODUCCION_COMPLETA' : 'PENDIENTE';

            // --- FASE 1: LECTURAS (SOLO 1 LECTURA) ---
            
            // LECTURA 1: Inventario (solo si ya existe localmente)
            let invDoc = null;
            let invRef = null;
            if (existingInv) {
                invRef = window.firebaseDoc(db, 'inventory', existingInv.id);
                invDoc = await transaction.get(invRef); // <--- LECTURA
            }

            // --- FASE 2: ESCRITURAS (TODAS DESPU√âS DE LECTURAS) ---

            // ESCRITURA 1 y 2: Crear Item/Location (si eran nuevos)
            if (isNewItem) {
                const itemRef = window.firebaseDoc(db, 'items', itemId);
                transaction.set(itemRef, { code: pieza, description: '', createdAt: now(), createdBy: username });
            }
            if (isNewLocation) {
                const locationRef = window.firebaseDoc(db, 'locations', locationId);
                transaction.set(locationRef, { qr: ubicacion, module: 'M?', row: 'F?', col: 'C?', createdAt: now(), createdBy: username });
            }

            // ESCRITURA 3: Crear la Work Order
            const workOrderId = uuid();
            const woData = {
                id: workOrderId, code: orden, itemCode: pieza,
                quantitySolicited: solicitado, 
                quantityProduced: cantidad, 
                quantityShipped: 0,
                status: initialStatus, 
                createdAt: now(),
                createdBy: username,
                description: descripcion
            };
            const woRef = window.firebaseDoc(db, 'workOrders', workOrderId);
            transaction.set(woRef, woData); 

            // ESCRITURA 4: Inventario
            let inventoryId;
            if (existingInv && invDoc && invDoc.exists()) {
                // Si el inventario existe, actual√≠zalo
                inventoryId = existingInv.id;
                const currentQuantity = invDoc.data().quantity || 0;
                const newQuantity = currentQuantity + cantidad;
                transaction.update(invRef, { quantity: newQuantity });
            } else {
                // Si no exist√≠a (o no estaba en Firestore), cr√©alo
                inventoryId = existingInv ? existingInv.id : uuid();
                invRef = window.firebaseDoc(db, 'inventory', inventoryId);
                transaction.set(invRef, { itemId, locationId, quantity: cantidad });
            }

            // ESCRITURA 5: Movimiento
            const movementId = uuid();
            const movementData = {
                itemCode: pieza, fromLocationQR: null, toLocationQR: ubicacion,
                quantity: cantidad, type: 'IN', workOrderCode: orden,
                createdAt: now(), createdBy: username,
                clientUuid: uuid(), edited: false, editedBy: null, editedAt: null
            };
            transaction.set(window.firebaseDoc(db, 'movements', movementId), movementData); 

        }, { maxAttempts: 3 });

        console.log('‚úÖ createWorkOrderTransaction (Corregida) completada con √©xito.');
    },

    // -------------------------------------------------------------------------
    // 5. GESTI√ìN DE ITEMS (Piezas)
    // -------------------------------------------------------------------------
    async saveItem(id, code, description) {
        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';
        const itemRef = id ? window.firebaseDoc(db, 'items', id) : window.firebaseDoc(db, 'items', uuid());
        const data = { code: code.trim(), description: description.trim() || '', createdBy: username };
        
        if (!id) {
            data.createdAt = now();
        }
        await window.firebaseSet(itemRef, data, { merge: true }); 
        console.log(`‚úÖ Pieza ${code} guardada/actualizada.`);
    },

    // -------------------------------------------------------------------------
    // 6. GESTI√ìN DE LOCATIONS (Ubicaciones)
    // -------------------------------------------------------------------------
    async saveLocation(id, qr, module, row, col) {
        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';
        const locationRef = id ? window.firebaseDoc(db, 'locations', id) : window.firebaseDoc(db, 'locations', uuid());
        const data = { 
            qr: qr.trim(), 
            module: module.trim() || 'M?', 
            row: row.trim() || 'F?', 
            col: col.trim() || 'C?', 
            createdBy: username 
        };
        
        if (!id) {
            data.createdAt = now();
        }
        await window.firebaseSet(locationRef, data, { merge: true });
        console.log(`‚úÖ Ubicaci√≥n ${qr} guardada/actualizada.`);
    },

// -------------------------------------------------------------------------
    // 7. GESTI√ìN DE ITEMS (Borrado Seguro) - ¬°¬°FALTABA!!
    // -------------------------------------------------------------------------
    async deleteItem(itemId, itemCode) {
        const db = window.firebaseDB;
        console.log(`[TRANSACCION] Iniciando deleteItemTransaction para ${itemCode} (ID: ${itemId})...`);

        // 1. Verificar si la pieza tiene historial de movimientos
        const movementsRef = window.firebaseCollection(db, 'movements');
        const movQuery = window.firebaseQuery(movementsRef, window.firebaseWhere('itemCode', '==', itemCode));
        const movSnapshot = await window.firebaseGetDocs(movQuery);
        if (!movSnapshot.empty) {
            throw new Error(`La pieza ${itemCode} tiene ${movSnapshot.size} movimiento(s) en el historial y no puede ser eliminada.`);
        }

        // 2. Verificar si la pieza est√° en √≥rdenes de fabricaci√≥n
        const woRef = window.firebaseCollection(db, 'workOrders');
        const woQuery = window.firebaseQuery(woRef, window.firebaseWhere('itemCode', '==', itemCode));
        const woSnapshot = await window.firebaseGetDocs(woQuery);
        if (!woSnapshot.empty) {
            throw new Error(`La pieza ${itemCode} est√° vinculada a ${woSnapshot.size} orden(es) de fabricaci√≥n y no puede ser eliminada.`);
        }
        
        // 3. Iniciar la transacci√≥n para verificar stock y borrar
        await window.firebaseRunTransaction(db, async (transaction) => {
            // 3A. Verificar si la pieza tiene stock
            const invRef = window.firebaseCollection(db, 'inventory');
            const invQuery = window.firebaseQuery(invRef, window.firebaseWhere('itemId', '==', itemId));
            const invSnapshot = await transaction.get(invQuery); // Lectura dentro de la TX
            
            let totalStock = 0;
            if (!invSnapshot.empty) {
                invSnapshot.docs.forEach(doc => {
                    totalStock += doc.data().quantity || 0;
                });
            }
            
            if (totalStock > 0) {
                throw new Error(`La pieza ${itemCode} tiene ${totalStock} uds en stock y no puede ser eliminada.`);
            }

            // 3B. Si todas las comprobaciones pasan, eliminar la pieza
            const itemRef = window.firebaseDoc(db, 'items', itemId);
            transaction.delete(itemRef); // Escritura
        });

        console.log(`‚úÖ Pieza ${itemCode} eliminada con √©xito.`);
    },

    // -------------------------------------------------------------------------
    // 8. GESTI√ìN DE WORK ORDERS (Borrado Seguro)
    // -------------------------------------------------------------------------
    async deleteWorkOrder(workOrderId, workOrderCode) {
        const db = window.firebaseDB;
        console.log(`[TRANSACCION] Iniciando deleteWorkOrderTransaction para ${workOrderCode} (ID: ${workOrderId})...`);

        await window.firebaseRunTransaction(db, async (transaction) => {
            // 1. Leer la Orden de Fabricaci√≥n
            const woRef = window.firebaseDoc(db, 'workOrders', workOrderId);
            const woDoc = await transaction.get(woRef);

            if (!woDoc.exists()) {
                throw new Error(`La Orden ${workOrderCode} no existe.`);
            }

            const woData = woDoc.data();

            // 2. Verificaci√≥n de Seguridad: Solo borrar si est√° "vac√≠a"
            const produccion = woData.quantityProduced || 0;
            const envios = woData.quantityShipped || 0;

            if (produccion > 0 || envios > 0) {
                throw new Error(`La Orden ${workOrderCode} no puede eliminarse porque tiene producci√≥n (${produccion}) o env√≠os (${envios}) registrados. Use la pesta√±a "Historial" y edite los movimientos a 0 primero.`);
            }

            // 3. Eliminar la Orden
            transaction.delete(woRef);
        });

        console.log(`‚úÖ Orden ${workOrderCode} eliminada con √©xito.`);
    },

    // -------------------------------------------------------------------------
    // 9. GESTI√ìN DE ITEMS (Archivado Seguro)
    // -------------------------------------------------------------------------
    async archiveItem(itemId, itemCode) {
        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';
        console.log(`[TRANSACCION] Iniciando archiveItemTransaction para ${itemCode} (ID: ${itemId})...`);

        await window.firebaseRunTransaction(db, async (transaction) => {
            // 1. Verificar que el stock sigue siendo 0 (doble chequeo)
            const invRef = window.firebaseCollection(db, 'inventory');
            const invQuery = window.firebaseQuery(invRef, window.firebaseWhere('itemId', '==', itemId));
            const invSnapshot = await transaction.get(invQuery); 
            
            let totalStock = 0;
            if (!invSnapshot.empty) {
                invSnapshot.docs.forEach(doc => {
                    totalStock += doc.data().quantity || 0;
                });
            }
            
            if (totalStock > 0) {
                throw new Error(`La pieza ${itemCode} tiene ${totalStock} uds en stock y no puede ser archivada. Aseg√∫rate de llevar el stock a 0 con un "Ajuste" primero.`);
            }

            // 2. Archivar la pieza
            const itemRef = window.firebaseDoc(db, 'items', itemId);
            transaction.update(itemRef, {
                status: 'archivado',
                archivedAt: now(),
                archivedBy: username
            });
        });

        console.log(`‚úÖ Pieza ${itemCode} archivada con √©xito.`);
    },

  // -------------------------------------------------------------------------
    // 4. ADJUST STOCK (Ajuste) - CORRECCI√ìN DE LA L√ìGICA DE ACTUALIZACI√ìN
    // -------------------------------------------------------------------------
    async adjustStock(itemCode, locationQR, countedQty) {
        if (countedQty < 0) throw new Error('La cantidad contada no puede ser negativa'); 

        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';

        await window.firebaseRunTransaction(db, async (transaction) => {
            console.log('[TRANSACCION] Iniciando adjustStockTransaction...');

            // A. Upsert Item y Location (ESCRITURA: Aunque no es un set en la misma transaction, 
            // garantiza que las IDs existan para las referencias de stock)
            const { itemId, locationId } = await this.upsertItemAndLocationInTransaction(transaction, itemCode, locationQR);
            
            // B. Buscar/Leer Inventario
            const existingInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === locationId);
            
            let inventoryId = existingInv ? existingInv.id : uuid();
            let currentQty = 0;
            let invRef = window.firebaseDoc(db, 'inventory', inventoryId);
            
            // Si el inventario existe en el Store, leemos el documento actual de Firestore (LECTURA)
            if (existingInv) {
                const invDoc = await transaction.get(invRef); 
                
                if(invDoc.exists()) {
                    currentQty = invDoc.data().quantity || 0;
                } else {
                    // Si exist√≠a en el Store pero no en Firestore (borrado), lo tratamos como nuevo
                    existingInv = null;
                    inventoryId = uuid();
                    invRef = window.firebaseDoc(db, 'inventory', inventoryId); // Nueva referencia con nuevo ID
                }
            }
            
            const difference = countedQty - currentQty;
            
            if (difference === 0) {
                throw new Error('La cantidad contada es igual al stock actual. No se requiere ajuste.');
            }

            // C. Aplicar Ajuste (ESCRITURA)
            if (countedQty === 0) {
                if (existingInv) { // Solo si el inventario exist√≠a antes de este ajuste
                    transaction.delete(invRef);
                }
                // Si existingInv era null y countedQty es 0, no hay que hacer nada.
            } else {
                if (existingInv) {
                    transaction.update(invRef, { quantity: countedQty });
                } else {
                    // Crear nuevo registro de inventario si no exist√≠a (usa la invRef generada)
                    transaction.set(invRef, { itemId, locationId, quantity: countedQty, createdAt: now(), createdBy: username });
                }
            }

            // D. Registrar Movimiento de Ajuste (ESCRITURA)
            const movementId = uuid();
            const movementData = {
                itemCode, fromLocationQR: null, toLocationQR: locationQR,
                quantity: difference, 
                type: 'ADJUST', workOrderCode: null,
                createdAt: now(), createdBy: username,
                clientUuid: uuid(), edited: false, editedBy: null, editedAt: null
            };
            transaction.set(window.firebaseDoc(db, 'movements', movementId), movementData); 

        }, { maxAttempts: 3 });

        console.log('‚úÖ adjustStockTransaction completada con √©xito.');
    },

    // -------------------------------------------------------------------------
    // 5. EDIT MOVEMENT (Fase 4: Admin) - CORE LOGIC (CORRECCI√ìN FINAL R/W)
    // -------------------------------------------------------------------------
  async editMovement(movementId, newQuantity) {
    if (newQuantity < 0) { throw new Error('La cantidad no puede ser negativa'); } // <-- ¬°ESTA ES LA CORRECCI√ìN!

        const db = window.firebaseDB;
        const username = state.currentUser ? state.currentUser.username : 'unknown';

        await window.firebaseRunTransaction(db, async (transaction) => {
            console.log(`[TRANSACCION] Iniciando editMovementTransaction para ${movementId}...`);

            // --- FASE 1: LECTURAS (TODAS las lecturas se hacen antes de cualquier escritura) ---

            const movementRef = window.firebaseDoc(db, 'movements', movementId);
            const movementDoc = await transaction.get(movementRef); // LECTURA 1: Movimiento original

            if (!movementDoc.exists()) {
                throw new Error(`Movimiento [${movementId}] no encontrado.`);
            }
            const M_orig = movementDoc.data();
            const originalQuantity = M_orig.quantity;
            const quantityDiff = newQuantity - originalQuantity; // Diferencia neta a aplicar (M_new - M_orig)

            if (quantityDiff === 0) {
                throw new Error('La nueva cantidad es igual a la original. No se requiere edici√≥n.');
            }

            const item = state.store.itemsByCode.get(M_orig.itemCode);
            if (!item) { throw new Error('Pieza no encontrada en el Store.'); }
            const itemId = item.id;
            
            // 1. Identificar las ubicaciones afectadas y sus referencias de Inventario
            const inventoryReferences = []; // { ref, locationQR, locationId, isTarget: boolean }
            
            const identifyInvRef = (locationQR, isTarget) => {
                const location = state.store.locationsByQr.get(locationQR);
                if (!location) throw new Error(`Ubicaci√≥n [${locationQR}] no encontrada en el Store.`);
                const locationId = location.id;
                
                const existingInv = state.store.inventory.find(inv => inv.itemId === itemId && inv.locationId === locationId);
                
                // Si existe en el store local, usamos su ID. Si no, generamos un ID nuevo (asumimos que ser√° un SET)
                const invId = existingInv ? existingInv.id : uuid(); 
                const ref = window.firebaseDoc(db, 'inventory', invId);
                
                inventoryReferences.push({ ref, locationQR, locationId, invId, existingInv, isTarget });
            };

            if (M_orig.type === 'IN') {
                identifyInvRef(M_orig.toLocationQR, true); // Destino (IN)
            } else if (M_orig.type === 'OUT') {
                identifyInvRef(M_orig.fromLocationQR, false); // Origen (OUT)
            } else if (M_orig.type === 'TRANSFER') {
                identifyInvRef(M_orig.fromLocationQR, false); // Origen (OUT)
                identifyInvRef(M_orig.toLocationQR, true); // Destino (IN)
            } 
            
            // 2. Ejecutar TODAS las lecturas de inventario (solo si exist√≠an localmente)
            const inventoryData = new Map(); // Mapa para guardar {ref: {doc, currentQty, ...}}
            
            for (const { ref, locationQR, existingInv } of inventoryReferences) {
                if (existingInv) {
                    const invDoc = await transaction.get(ref); // LECTURA 2 (m√∫ltiple): Inventario
                    if (!invDoc.exists()) { 
                        // Error si un inventario que esper√°bamos leer no existe
                        throw new Error(`Inventario para ${locationQR} no existe en Firestore. Fallo.`); 
                    }
                    inventoryData.set(ref, { doc: invDoc, currentQty: invDoc.data().quantity || 0 });
                } else {
                    // Si no exist√≠a localmente, no leemos, la cantidad actual es 0
                    inventoryData.set(ref, { doc: null, currentQty: 0 });
                }
            }
            
            // 3. Lectura de Work Order (si aplica)
            let woData = null;
            let woRef = null;
            if (M_orig.workOrderCode) {
                const existingWO = state.store.workOrders.find(w => w.code === M_orig.workOrderCode);
                if (existingWO) { 
                    woRef = window.firebaseDoc(db, 'workOrders', existingWO.id);
                    const woDoc = await transaction.get(woRef); // LECTURA 3: Work Order
                    if (woDoc.exists()) {
                        woData = woDoc.data();
                    }
                }
            }


            // --- FASE 2: C√ÅLCULOS Y ESCRITURAS ---
            
            // 1. Calcular nuevos stocks y aplicar actualizaciones de inventario (ESCRITURA)
            for (const { ref, locationQR, locationId, invId, existingInv, isTarget } of inventoryReferences) {
                const { currentQty } = inventoryData.get(ref);
                
                let change = 0;
                
                // Si el movimiento original era una ENTRADA (es target), el cambio es quantityDiff (+)
                if (M_orig.type === 'IN' && isTarget) {
                    change = quantityDiff; 
                } 
                // Si el movimiento original era una SALIDA (es origen), el cambio es -quantityDiff (inverso)
                else if (M_orig.type === 'OUT' && !isTarget) {
                    change = -quantityDiff; 
                } 
                // Si era un TRASLADO, el target es IN (+), el origen es OUT (-)
                else if (M_orig.type === 'TRANSFER') {
                    change = isTarget ? quantityDiff : -quantityDiff;
                }

                const newQuantityInv = currentQty + change;

                if (newQuantityInv < 0) {
                    throw new Error(`Stock insuficiente en ${locationQR} para aplicar la edici√≥n. Cantidad final: ${newQuantityInv}.`);
                }
                
                // Aplicar Escritura
                if (newQuantityInv === 0) {
                    transaction.delete(ref);
                } else if (existingInv) {
                    transaction.update(ref, { quantity: newQuantityInv });
                } else {
                    // Crear nuevo registro si no exist√≠a (existingInv=null) y la cantidad final es > 0
                    transaction.set(ref, { itemId, locationId, quantity: newQuantityInv, createdAt: now(), createdBy: username });
                }
            }

            // 2. Actualizar Work Order (ESCRITURA)
            if (M_orig.workOrderCode && woRef && woData) {
                let newProduced = woData.quantityProduced;
                let newShipped = woData.quantityShipped;
                
                // Actualizar la m√©trica afectada (Solo IN afecta producido, solo OUT afecta enviado)
                if (M_orig.type === 'IN') {
                    newProduced += quantityDiff; 
                    if (newProduced < 0) newProduced = 0;
                } else if (M_orig.type === 'OUT') {
                    newShipped += quantityDiff; 
                    if (newShipped < 0) newShipped = 0;
                }

                // Recalcular Status
                let newStatus = woData.status;
                const solicited = woData.quantitySolicited || 0;

                if (newShipped >= solicited) {
                    newStatus = 'COMPLETADA';
                } else if (newShipped > 0) {
                    newStatus = 'ENVIO_PARCIAL';
                } else if (newProduced >= solicited) {
                    newStatus = 'PRODUCCION_COMPLETA';
                } else {
                    newStatus = 'PENDIENTE';
                }

                transaction.update(woRef, { 
                    quantityProduced: newProduced, 
                    quantityShipped: newShipped,
                    status: newStatus 
                });
            }

            // 3. ACTUALIZAR MOVIMIENTO (ESCRITURA)
            transaction.update(movementRef, {
                quantity: newQuantity,
                edited: true,
                editedBy: username,
                editedAt: now()
            });

        }, { maxAttempts: 3 });

        console.log('‚úÖ editMovementTransaction completada con √©xito.');
    }
 }

  const state = {
    store: Store.load(), 
    isAuthenticated: false,
    currentUser: null,
    activeTab: 'inicio',
    isLoading: false,
    historialFiltro: 'general',
    historialBusqueda: '',
    buscarPor: 'pieza',
    creatingWorkOrder: false,
    pendingWorkOrderData: null,
    ordenesSearchTerm: '',
    ordenesFilter: 'activas',
    theme: localStorage.getItem(THEME_KEY) || 'light',
    showExcesoModal: false,
    excesoData: null,
    enviandoWorkOrder: null, 
catalogoSubTab: 'piezas', 
    ajustePieza: '',       
    ajusteUbicacion: '', 
    showVerificarItemModal: false,  
    verificandoItemData: null,    
    charts: {
      tendencia: null,
      estadoOrdenes: null
    }
  };
  
  function buildStoreMaps(store) {
    store.itemsMap = new Map(store.items.map(i => [i.id, i]));
    store.locationsMap = new Map(store.locations.map(l => [l.id, l]));
    store.itemsByCode = new Map(store.items.map(i => [i.code, i]));
    store.locationsByQr = new Map(store.locations.map(l => [l.qr, l]));
  }
  buildStoreMaps(state.store);

  let html5QrCode = null;
  let currentInputId = null;

  document.documentElement.setAttribute('data-theme', state.theme);

  function cambiarTema(tema) {
    if (tema) {
      state.theme = tema;
    } else {
      const temas = ['light', 'semi-dark', 'dark'];
      const currentIndex = temas.indexOf(state.theme);
      state.theme = temas[(currentIndex + 1) % temas.length];
    }
    localStorage.setItem(THEME_KEY, state.theme);
    aplicarTema();
  }

  function aplicarTema() {
    document.documentElement.setAttribute('data-theme', state.theme);
    const temaLabel = state.theme === 'light' ? '‚òÄÔ∏è' : state.theme === 'semi-dark' ? 'üåó' : 'üåô';
    const themeButton = document.getElementById('theme-toggle-button');
    if (themeButton) {
      themeButton.innerHTML = temaLabel;
    }
    if (state.activeTab === 'inicio') {
      actualizarColoresGraficos();
    }
  }

  function exportarJSON() {
    const dataToExport = Store.load();
    const blob = new Blob([JSON.stringify(dataToExport)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    const fileName = `logistica-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
    a.href = url; a.download = fileName; a.click();
    URL.revokeObjectURL(url);
  }

  function importarJSON(file) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const json = JSON.parse(String(reader.result));
        if (!json || typeof json !== 'object' || !json.schemaVersion) {
          throw new Error('Archivo inv√°lido');
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(json));
        showCustomAlert('Importaci√≥n Deshabilitada', 'La importaci√≥n local solo afecta al store simulado. En esta versi√≥n con Firestore, se recomienda manipular la base de datos directamente.');
      } catch (e) {
        showCustomAlert('Error de Importaci√≥n', 'No se pudo importar: ' + (e && e.message ? e.message : e));
      }
    };
    reader.readAsText(file);
  }

  function triggerImport() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) importarJSON(file);
    };
    input.click();
  }

  // === FASE 1: FIREBASE AUTHENTICATION (INALTERADO) ===
  const FIREBASE_USERS = {
    'admin@erca.com': { role: 'admin', nombre_completo: 'Administrador' },
    'operario@erca.com': { role: 'user', nombre_completo: 'Operario 1' },
    'lsalguero@erca.com': { role: 'user', nombre_completo: 'Salguero Lucas' },
    'pcasas@erca.com': { role: 'user', nombre_completo: 'Casas Pablo' }
  };

  function setupAuthListener() {
    if (!window.firebaseAuth || !window.firebaseOnAuthStateChanged) {
      console.warn('Firebase Auth no est√° disponible');
      return;
    }

    window.firebaseOnAuthStateChanged(window.firebaseAuth, (user) => {
      if (user) {
        const userEmail = user.email;
        const userData = FIREBASE_USERS[userEmail];
        
        if (userData) {
          state.currentUser = {
            username: userEmail.split('@')[0],
            email: userEmail,
            ...userData
          };
          state.isAuthenticated = true;
          console.log('‚úÖ Usuario autenticado:', state.currentUser.username);
          
          setupFirestoreListener(); 
          
          render();
        }
      } else {
        state.currentUser = null;
        state.isAuthenticated = false;
        
        if (unsubscribeFirestore) {
            unsubscribeFirestore();
            unsubscribeFirestore = null;
        }

        render();
      }
    });
  }

  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const finalEmail = email.includes('@') ? email : `${email}@erca.com`;

    try {
      await window.firebaseSignIn(window.firebaseAuth, finalEmail, password);
      console.log('‚úÖ Login exitoso:', finalEmail);
    } catch (error) {
      console.error('‚ùå Error en login:', error);
      let mensaje = 'Usuario o contrase√±a incorrectos';
      if (error.code === 'auth/user-not-found') mensaje = 'Usuario no encontrado'; 
      else if (error.code === 'auth/wrong-password') mensaje = 'Contrase√±a incorrecta'; 
      else if (error.code === 'auth/invalid-credential') mensaje = 'Credenciales inv√°lidas';
      
      showCustomAlert('Error de Autenticaci√≥n', mensaje);
    }
  }

  async function handleLogout() {
    try {
      await window.firebaseSignOut(window.firebaseAuth);
      console.log('‚úÖ Logout exitoso');
    } catch (error) {
      console.error('‚ùå Error en logout:', error);
      showCustomAlert('Error', 'Error al cerrar sesi√≥n');
    }
  }

  window.addEventListener('load', () => {
    setTimeout(() => {
      setupAuthListener();
    }, 1000);
  });
  // === FIN FASE 1 ===

  // --- Funciones de Utilidad y Negocio ---
  
const AUTO_CLOSE_TIME = 2500; // 2500 milisegundos = 2.5 segundos

  function showCustomAlert(title, message, isError = false) {
    const modal = document.getElementById('customAlertModal');
    const iconContainer = modal.querySelector('.mx-auto.w-12.h-12.flex');
    const icon = document.getElementById('alertIcon');
    const btnContainer = document.getElementById('alertButtonContainer');
    
    // Limpieza de clases para empezar desde un estado neutral
    iconContainer.classList.remove('bg-red-100', 'bg-green-100', 'bg-blue-100');
    icon.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
    
    document.getElementById('customAlertTitle').textContent = title;
    document.getElementById('customAlertMessage').textContent = message;

    // 1. Personaliza el color
    let autoClose = true;
    if (title.startsWith('‚ùå Error') || isError) {
        iconContainer.classList.add('bg-red-100');
        icon.classList.add('text-red-600');
        autoClose = false; // No auto-cerrar errores graves
    } else if (title.startsWith('‚úÖ')) {
        iconContainer.classList.add('bg-green-100');
        icon.classList.add('text-green-600');
    } else {
        iconContainer.classList.add('bg-blue-100');
        icon.classList.add('text-blue-600');
    }

    modal.classList.remove('hidden');
    
    // 2. Controla el bot√≥n y el temporizador
    if (autoClose) {
        btnContainer.classList.add('hidden'); // Oculta el bot√≥n
        setTimeout(() => {
            modal.classList.add('hidden');
        }, AUTO_CLOSE_TIME);
    } else {
        btnContainer.classList.remove('hidden'); // Muestra el bot√≥n para errores
    }
  }
  
  function closeCustomAlert() {
    // Funci√≥n llamada solo por el bot√≥n "Aceptar"
    document.getElementById('customAlertModal').classList.add('hidden');
  }

function showLoader() {
    if (state.isLoading) return; // Ya est√° activo
    state.isLoading = true;
    renderModalsContainer(); // Dibuja el modal de carga
  }
  function hideLoader() {
    if (!state.isLoading) return; // Ya est√° inactivo
    state.isLoading = false;
    renderModalsContainer(); // Oculta el modal de carga
  }

  function autocompletarPiezaDesdeOrden(ordenCode) {
    if (!ordenCode || ordenCode.length < 3) return; 
    const wo = state.store.workOrders.find(w => w.code === ordenCode);
    if (wo) {
      const itemInput = document.getElementById('entradaPieza');
      if (itemInput) {
        itemInput.value = wo.itemCode;
        actualizarAlertaUbicaciones(); 
      }
    }
  }
  
  function iniciarScanner(inputId) {
    currentInputId = inputId;
    document.getElementById('scannerModal').classList.remove('hidden');
    setTimeout(() => {
      html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          
          let targetInputId = currentInputId; 

          const input = document.getElementById(targetInputId);
          if (input) {
            input.value = decodedText;
            input.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-green-500'), 2000);
          }

          cerrarScanner();

          if (targetInputId === 'entradaOrden' && decodedText) {
             autocompletarPiezaDesdeOrden(decodedText);
          }

          if (currentInputId === 'entradaPieza' && targetInputId === 'entradaPieza') actualizarAlertaUbicaciones();
          if (currentInputId === 'salidaPieza') mostrarUbicacionesDisponibles();
          if (currentInputId === 'busquedaPieza' || currentInputId === 'busquedaUbicacion') buscarInventario();
          if (currentInputId === 'traslado_pieza') mostrarUbicacionesTraslado();
        }
      ).catch(() => {
        showCustomAlert('Error', 'No se puede acceder a la c√°mara.');
        cerrarScanner();
      });
    }, 100);
  }

  function cerrarScanner() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
        document.getElementById('scannerModal').classList.add('hidden');
      }).catch(() => {
        html5QrCode = null;
        document.getElementById('scannerModal').classList.add('hidden');
      });
    } else {
      document.getElementById('scannerModal').classList.add('hidden');
    }
  }

  function mostrarModalNuevaOF(pieza, orden, ubicacion, cantidad) {
    state.pendingWorkOrderData = { pieza, orden, ubicacion, cantidad };
    state.creatingWorkOrder = true;
    renderContenido(); 
  }

  async function crearNuevaOF() {
    const solicitado = parseInt(document.getElementById('of_cantidad_solicitada').value);
    const descripcion = document.getElementById('of_descripcion').value.trim();
    if (!solicitado || solicitado <= 0) {
      showCustomAlert('‚ö†Ô∏è Advertencia', 'Ingresa una cantidad solicitada v√°lida');
      return;
    }
    const { pieza, orden, ubicacion, cantidad } = state.pendingWorkOrderData;
    
    const cantidadParaOF = Math.min(cantidad, solicitado);
    const exceso = cantidad - cantidadParaOF;
    
    // El loader ya deber√≠a estar activo, pero lo re-aseguramos
    showLoader();
    try {
        await Store.createWorkOrder(pieza, orden, ubicacion, cantidadParaOF, solicitado, descripcion);
        
        state.creatingWorkOrder = false;
        
        // Manejar el exceso si lo hay
        if (exceso > 0) {
            // Reutilizamos el modal de exceso para el sobrante
            state.excesoData = {
                pieza, orden, ubicacion, cantidad: exceso,
                solicitado,
                producido: cantidadParaOF, 
                exceso,
                cantidadParaCompletar: 0 // Ya se complet√≥ la OF
            };
            state.showExcesoModal = true;
            renderContenido(); 
            showCustomAlert('‚úÖ Orden Creada', `Orden ${orden} creada y completada con ${cantidadParaOF} uds. Faltan ${exceso} uds por asignar.`);
            // NO apagamos el loader, el nuevo modal de exceso lo manejar√°
        } else {
            // Flujo normal (sin exceso sobre la nueva OF)
            state.pendingWorkOrderData = null;
            showCustomAlert('‚úÖ √âxito', 'Orden creada y entrada registrada');
            limpiarFormularioEntrada();
            actualizarUIDesdeMovimiento(); 
            renderContenido(); 
            hideLoader(); // <-- APAGAR aqu√≠
        }

    } catch(e) {
        console.error("Error al crear OF y registrar entrada:", e);
        showCustomAlert('‚ùå Error al crear Orden y registrar entrada', `Error de transacci√≥n al registrar la entrada: ${e.message}`);
        hideLoader(); // <-- APAGAR en error
    }
  }

  function cancelarNuevaOF() {
    state.creatingWorkOrder = false;
    state.pendingWorkOrderData = null;
    renderContenido(); 
  }

  async function procesarEntrada() {
    const pieza = document.getElementById('entradaPieza').value.trim();
    const orden = document.getElementById('entradaOrden').value.trim();
    const ubicacion = document.getElementById('entradaUbicacion').value.trim();
    const cantidad = parseInt(document.getElementById('entradaCantidad').value);
    
    if (!pieza || !ubicacion || isNaN(cantidad) || cantidad <= 0) {
      showCustomAlert('‚ö†Ô∏è Advertencia', 'Completa los campos obligatorios: Pieza, Ubicaci√≥n y Cantidad positiva.');
      return;
    }

    showLoader(); // <-- ENCENDER
    try {
        const wo = orden ? state.store.workOrders.find(w => w.code === orden) : null;
        
        if (orden && !wo) {
            // Si la orden no existe, preguntamos si quiere crearla.
            mostrarModalNuevaOF(pieza, orden, ubicacion, cantidad);
            // NOTA: hideLoader() se llamar√° cuando 'crearNuevaOF' termine (lo acabamos de programar)
        } else if (wo && wo.quantityProduced >= wo.quantitySolicited) {
            // Si la OF existe y ya est√° completa en producci√≥n
            const exceso = cantidad;
            state.excesoData = {
                pieza, orden, ubicacion, cantidad: exceso,
                solicitado: wo.quantitySolicited,
                producido: wo.quantityProduced,
                exceso,
                cantidadParaCompletar: 0 
            };
            state.showExcesoModal = true;
            renderContenido(); 
            showCustomAlert('‚ö†Ô∏è Advertencia', `La Orden ${orden} ya tiene producci√≥n completa. Define d√≥nde cargar las ${cantidad} uds.`);
            hideLoader(); // <-- APAGAR (flujo sin 'await')
        } else if (wo && (wo.quantityProduced + cantidad) > wo.quantitySolicited) {
             // Si la OF existe, pero la nueva entrada excede lo solicitado
            const cantidadParaCompletar = wo.quantitySolicited - wo.quantityProduced;
            const exceso = cantidad - cantidadParaCompletar;
            
            state.excesoData = {
                pieza, orden, ubicacion, cantidad,
                solicitado: wo.quantitySolicited,
                producido: wo.quantityProduced,
                exceso,
                cantidadParaCompletar
            };
            state.showExcesoModal = true;
            renderContenido(); 
            showCustomAlert('‚ö†Ô∏è Alerta de Exceso', `Esta entrada excede lo solicitado en la Orden ${orden}. Debes reasignar el sobrante.`);
            hideLoader(); // <-- APAGAR (flujo sin 'await')
        } else {
            // Flujo normal: Cargar stock en orden existente o sin orden
            await Store.addStock(pieza, ubicacion, cantidad, orden || null);
            showCustomAlert('‚úÖ √âxito', 'Entrada registrada');
            limpiarFormularioEntrada();
            actualizarUIDesdeMovimiento();
            hideLoader(); // <-- APAGAR (despu√©s del 'await')
        }

    } catch(e) {
        console.error("Error al procesar entrada:", e);
        showCustomAlert('‚ùå Error de Transacci√≥n', `Error al registrar la entrada: ${e.message}`);
        hideLoader(); // <-- APAGAR (en caso de error)
    }
  }

  function cerrarModalExceso() {
    state.showExcesoModal = false;
    state.excesoData = null;
    renderContenido(); 
  }

  async function cargarEnOtraOrden() {
    const { pieza, orden, ubicacion, cantidad, cantidadParaCompletar, exceso } = state.excesoData;
    
    showLoader(); // <-- ENCENDER
    try {
        // 1. Cargar la cantidad necesaria para completar la OF original
        if (cantidadParaCompletar > 0) {
            await Store.addStock(pieza, ubicacion, cantidadParaCompletar, orden);
        }
    } catch (e) {
        showCustomAlert('‚ùå Error Parcial', `Error al completar la orden ${orden}: ${e.message}`);
        hideLoader(); // <-- APAGAR (si el primer paso falla)
        return;
    }

    // 2. Pedir la nueva orden para el exceso
    // APAGAMOS el loader temporalmente para que se vea el 'prompt'
    hideLoader(); 
    const nuevaOrden = prompt(`Ingresa el c√≥digo de la nueva Orden de Fabricaci√≥n para las ${exceso} uds restantes:`);
    
    // 3. Si el usuario cancela o pone la misma orden
    if (!nuevaOrden || nuevaOrden.trim() === orden) {
      showLoader(); // <-- ENCENDER de nuevo
      try {
        await Store.addStock(pieza, ubicacion, exceso, null);
        showCustomAlert('‚úÖ Sobrante sin Orden', `${exceso} uds cargadas sin orden.`);
      } catch(e) {
        showCustomAlert('‚ùå Error de Transacci√≥n', `Error al cargar el sobrante sin orden: ${e.message}`);
      } finally {
        hideLoader(); // <-- APAGAR
        cerrarModalExceso();
        limpiarFormularioEntrada();
        actualizarUIDesdeMovimiento();
      }
      return;
    }
    
    // 4. Si es una orden nueva, buscarla
    showLoader(); // <-- ENCENDER de nuevo
    try {
        const existingWO = state.store.workOrders.find(w => w.code === nuevaOrden);
        if (!existingWO) {
          // 5A. Si la NUEVA orden NO existe
          mostrarModalNuevaOF(pieza, nuevaOrden, ubicacion, exceso);
          cerrarModalExceso(); 
          // NOTA: 'mostrarModalNuevaOF' ahora debe manejar su propio loader (y ya lo hace)
        } else {
          // 5B. Si la NUEVA orden S√ç existe
          const pendienteNuevaWO = existingWO.quantitySolicited - existingWO.quantityProduced;
          
          if (exceso > pendienteNuevaWO) {
            // ... (l√≥gica recursiva, no hay 'await' aqu√≠)
            state.excesoData = {
              pieza, orden: nuevaOrden, ubicacion, cantidad: exceso,
              solicitado: existingWO.quantitySolicited,
              producido: existingWO.quantityProduced,
              exceso: exceso - pendienteNuevaWO,
              cantidadParaCompletar: pendienteNuevaWO
            };
            showCustomAlert('‚ö†Ô∏è Alerta de Exceso', `El sobrante excede lo solicitado en la nueva OF ${nuevaOrden}. Define el nuevo exceso.`);
            renderContenido(); 
            hideLoader(); // <-- APAGAR
          } else {
            try {
              // Cargar el exceso completamente en la nueva OF
              await Store.addStock(pieza, ubicacion, exceso, nuevaOrden);
              showCustomAlert('‚úÖ √âxito', `${exceso} uds cargadas en orden ${nuevaOrden}`);
              cerrarModalExceso(); 
            } catch(e) {
              showCustomAlert('‚ùå Error de Transacci√≥n', `Error al cargar el exceso en ${nuevaOrden}: ${e.message}`);
              cerrarModalExceso(); 
            } finally {
                hideLoader(); // <-- APAGAR
            }
          }
        }
    } finally {
        // Limpieza final, solo si el loader sigue activo
        if (state.isLoading && !state.creatingWorkOrder) hideLoader(); 
        limpiarFormularioEntrada();
        actualizarUIDesdeMovimiento();
    }
  }

  // BUG FIX #2: Implementaci√≥n correcta del bot√≥n Cargar Sin Orden
  async function cargarSinOrden() {
    const { pieza, orden, ubicacion, cantidadParaCompletar, exceso } = state.excesoData;
    let mensaje = '‚úÖ Entrada registrada:';
    
    showLoader(); // <-- ENCENDER
    try {
        // 1. Cargar la cantidad necesaria para completar la OF original
        if (cantidadParaCompletar > 0) {
            await Store.addStock(pieza, ubicacion, cantidadParaCompletar, orden);
            mensaje += `\n- ${cantidadParaCompletar} uds en ${orden} (Completada)`;
        }
        
        // 2. Cargar el exceso SIN orden
        if (exceso > 0) {
            await Store.addStock(pieza, ubicacion, exceso, null);
            mensaje += `\n- ${exceso} uds sin orden`;
        }

        showCustomAlert('‚úÖ √âxito', mensaje);
        cerrarModalExceso();
        limpiarFormularioEntrada();
        actualizarUIDesdeMovimiento();

    } catch(e) {
        showCustomAlert('‚ùå Error de Transacci√≥n', `Error al cargar stock: ${e.message}`);
    } finally {
        hideLoader(); // <-- APAGAR
    }
  }

  function limpiarFormularioEntrada() {
    const elPieza = document.getElementById('entradaPieza');
    const elOrden = document.getElementById('entradaOrden');
    const elUbicacion = document.getElementById('entradaUbicacion');
    const elCantidad = document.getElementById('entradaCantidad');
    
    if (elPieza) elPieza.value = '';
    if (elOrden) elOrden.value = '';
    if (elUbicacion) elUbicacion.value = '';
    if (elCantidad) elCantidad.value = '';
    
    actualizarAlertaUbicaciones();
  }

  function actualizarAlertaUbicaciones() {
    const elPieza = document.getElementById('entradaPieza');
    const elAlerta = document.getElementById('alertaUbicaciones');
    if (!elPieza || !elAlerta) return;
    
    const pieza = elPieza.value.trim();
    if (!pieza) {
      elAlerta.innerHTML = '';
      return;
    }
    
    // Usamos el Store para buscar el inventario actual
    const stock = Store.getInventory(state.store, pieza);
    
    if (stock.length > 0) {
      // Si hay stock, mostramos d√≥nde
      const ubicacionesStr = stock.map(s => `${s.locationQR} (${s.quantity})`).join(', ');
      elAlerta.innerHTML = `
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-3 text-xs mt-4">
          <p class="font-semibold text-blue-900">Info: Esta pieza ya tiene stock en:</p>
          <p class="text-blue-700">${ubicacionesStr}</p>
        </div>
      `;
    } else {
      // Si no hay stock, limpiamos la alerta
      elAlerta.innerHTML = '';
    }
  }

  function getOrdenesPendientes(itemCode) {
    return state.store.workOrders.filter(wo => 
      wo.itemCode === itemCode && 
      wo.status !== 'COMPLETADA' &&
      wo.quantityShipped < wo.quantitySolicited
    );
  }

  function mostrarUbicacionesDisponibles() {
    const el = document.getElementById('salidaPieza');
    if (!el) return;
    const pieza = el.value.trim();
    const ubicacionesDiv = document.getElementById('ubicacionesDisponibles');
    const selectorOrdenDiv = document.getElementById('selectorOrden');
    if (!ubicacionesDiv || !selectorOrdenDiv) return;

    if (!pieza) { 
      ubicacionesDiv.innerHTML = ''; 
      selectorOrdenDiv.innerHTML = '';
      return; 
    }
    const ubicaciones = Store.getInventory(state.store, pieza);
    const ordenesPendientes = getOrdenesPendientes(pieza);
    if (ordenesPendientes.length > 0) {
      selectorOrdenDiv.innerHTML = `
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 mb-4">
          <p class="font-semibold text-blue-900 text-sm mb-2">√ìrdenes Pendientes para esta Pieza</p>
          <p class="text-xs text-blue-700 mb-3">Debes seleccionar una orden para continuar</p>
          <select id="salidaOrdenObligatoria" class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm bg-white">
            <option value="">-- Selecciona una Orden --</option>
            ${ordenesPendientes.map(wo => {
              const pendiente = wo.quantitySolicited - wo.quantityShipped;
              return `<option value="${wo.code}">${wo.code} - Pendiente: ${pendiente} uds (${wo.description || 'Sin descripci√≥n'})</option>`;
            }).join('')}
          </select>
        </div>
      `;
    } else {
      selectorOrdenDiv.innerHTML = `
        <div class="mb-4">
          <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Orden de Fabricaci√≥n (opcional)</label>
          <input type="text" id="salidaOrden" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="OF-2024-001">
          <p class="text-xs mt-1" style="color: var(--color-text-secondary);">Vincular env√≠o a orden espec√≠fica</p>
        </div>
      `;
    }
    if (ubicaciones.length === 0) {
      ubicacionesDiv.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
          <p class="text-red-700 font-medium">Sin stock disponible</p>
        </div>
      `;
      return;
    }
    ubicacionesDiv.innerHTML = `
      <div class="space-y-2">
        <h3 class="font-medium text-sm" style="color: var(--color-text);">Ubicaciones Disponibles</h3>
        ${ubicaciones.map((item, index) => `
          <div class="card-minimal rounded-lg p-3">
            <p class="font-semibold" style="color: var(--color-text);">${item.locationQR}</p>
            <p class="text-sm mb-2" style="color: var(--color-text-secondary);">Disponible: ${item.quantity} uds</p>
            <input 
              type="number" 
              id="cantidadSalida_${index}" 
              data-ubicacion="${item.locationQR}"
              data-disponible="${item.quantity}"
              class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" 
              style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);"
              placeholder="Cantidad"
              min="0" max="${item.quantity}">
          </div>
        `).join('')}
      </div>
    `;
  }
  
  async function procesarSalida() {
    try {
      
      const pieza = document.getElementById('salidaPieza').value.trim();
      if (!pieza) { showCustomAlert('‚ö†Ô∏è Advertencia', 'Ingresa el c√≥digo de pieza'); return; }
      
      const ubicaciones = Store.getInventory(state.store, pieza);
      if (ubicaciones.length === 0) { showCustomAlert('‚ùå Error', 'No hay stock disponible'); return; }
      
      const ordenesPendientes = getOrdenesPendientes(pieza);
      let ordenSalida = null;
      
      if (ordenesPendientes.length > 0) {
        const selectOrden = document.getElementById('salidaOrdenObligatoria');
        ordenSalida = selectOrden ? selectOrden.value : null;
        if (!ordenSalida) {
          showCustomAlert('‚ö†Ô∏è Advertencia', 'Debes seleccionar una Orden de Fabricaci√≥n para esta pieza');
          return;
        }
      } else {
        const inputOrden = document.getElementById('salidaOrden');
        ordenSalida = inputOrden ? inputOrden.value.trim() : null;
      }
      
      const picks = [];
      let totalSalida = 0;
      
      ubicaciones.forEach((item, index) => {
        const input = document.getElementById(`cantidadSalida_${index}`);
        const cantidad = parseInt(input.value) || 0;
        if (cantidad > 0) {
          if (cantidad > item.quantity) {
            throw new Error(`Stock insuficiente en ${item.locationQR}: Quieres sacar ${cantidad} pero solo hay ${item.quantity}`);
          }
          picks.push({ locationQR: item.locationQR, quantity: cantidad });
          totalSalida += cantidad;
        }
      });
      
      if (picks.length === 0) { showCustomAlert('‚ö†Ô∏è Advertencia', 'Ingresa al menos una cantidad'); return; }

      // --- INICIO DE LA CORRECCI√ìN ESTRICTA (FIX v20.7) ---
      if (ordenSalida) {
        const wo = state.store.workOrders.find(w => w.code === ordenSalida);
        if (wo) {
          const pendienteEnviar = wo.quantitySolicited - wo.quantityShipped;
          if (totalSalida > pendienteEnviar) {
            showCustomAlert('‚ùå Error de Env√≠o', `La cantidad total a enviar (${totalSalida} uds) excede estrictamente las ${pendienteEnviar} uds pendientes para la OF ${ordenSalida}. Por favor, corrige la cantidad.`);
            return; // <--- BLOQUEO ESTRICTO
          }
        }
      }
      // --- FIN DE LA CORRECCI√ìN ESTRICTA ---
    
      showLoader(); // <-- ENCENDER
      
      // --- CORRECCI√ìN ---
      await Store.removeStockSplit(pieza, picks, ordenSalida);
      // --------------------
      
      if (ordenSalida) {
        const wo = state.store.workOrders.find(w => w.code === ordenSalida);
        if (wo && (wo.quantityShipped + totalSalida) >= wo.quantitySolicited) {
          showCustomAlert('‚úÖ Salida Registrada', `Orden completada: ${(wo.quantityShipped + totalSalida)}/${wo.quantitySolicited} uds enviadas`);
        } else {
          showCustomAlert('‚úÖ √âxito', 'Salida registrada');
        }
      } else {
        showCustomAlert('‚úÖ √âxito', 'Salida registrada');
      }
      
      document.getElementById('salidaPieza').value = '';
      
      mostrarUbicacionesDisponibles();
      actualizarUIDesdeMovimiento();
      if (state.activeTab === 'ordenes') renderContenido();

    } catch (e) {
      showCustomAlert('‚ùå Error de Transacci√≥n', 'Error: ' + e.message);
    } finally {
      // Nos aseguramos de que el loader se oculte si est√° activo
      if (state.isLoading) hideLoader(); // <-- APAGAR
    }
  }

  function mostrarUbicacionesTraslado() {
    const el = document.getElementById('traslado_pieza');
    if (!el) return;
    const pieza = el.value.trim();
    const div = document.getElementById('traslado_ubicaciones');
    if (!div) return;

    if (!pieza) { div.innerHTML = ''; return; }
    const ubicaciones = Store.getInventory(state.store, pieza);
    if (ubicaciones.length === 0) {
      div.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
          <p class="text-red-700 font-medium">Sin stock disponible</p>
        </div>
      `;
      return;
    }
    div.innerHTML = `
      <div class="space-y-2">
        <h3 class="font-medium text-sm" style="color: var(--color-text);">Selecciona Origen</h3>
        ${ubicaciones.map(item => `
          <button onclick="seleccionarOrigenTraslado('${item.locationQR}', ${item.quantity})" 
            class="w-full card-minimal rounded-lg p-3 text-left hover:bg-gray-500/10 transition">
            <p class="font-semibold" style="color: var(--color-text);">${item.locationQR}</p>
            <p class="text-sm" style="color: var(--color-text-secondary);">Disponible: ${item.quantity} uds</p>
          </button>
        `).join('')}
      </div>
    `;
  }

  function seleccionarOrigenTraslado(ubicacionQR, disponible) {
    document.getElementById('traslado_origen_hidden').value = ubicacionQR;
    document.getElementById('traslado_disponible').value = disponible;
    document.getElementById('paso1_traslado').classList.add('hidden');
    document.getElementById('paso2_traslado').classList.remove('hidden');
    document.getElementById('info_origen').textContent = `Origen: ${ubicacionQR} (${disponible} uds)`;
  }

  function volverPaso1Traslado() {
    document.getElementById('paso1_traslado').classList.remove('hidden');
    document.getElementById('paso2_traslado').classList.add('hidden');
  }

  async function procesarTraslado() {
    const pieza = document.getElementById('traslado_pieza').value.trim();
    const origenQR = document.getElementById('traslado_origen_hidden').value;
    const destinoQR = document.getElementById('traslado_destino').value.trim();
    const cantidad = parseInt(document.getElementById('traslado_cantidad').value);
    const disponible = parseInt(document.getElementById('traslado_disponible').value);
    if (!pieza || !origenQR || !destinoQR || !cantidad) {
      showCustomAlert('‚ö†Ô∏è Advertencia', 'Completa todos los campos');
      return;
    }
    if (cantidad > disponible) {
      showCustomAlert('‚ö†Ô∏è Advertencia', `Solo hay ${disponible} unidades disponibles`);
      return;
    }
    if (origenQR === destinoQR) {
      showCustomAlert('‚ö†Ô∏è Advertencia', 'Origen y destino no pueden ser iguales');
      return;
    }
    
    showLoader(); // <-- ENCENDER
    try {
      // --- CORRECCI√ìN ---
      await Store.transferStock(pieza, origenQR, destinoQR, cantidad); 
      // --------------------
      showCustomAlert('‚úÖ Traslado Completado', `${cantidad} uds: ${origenQR} ‚Üí ${destinoQR}`);
      document.getElementById('traslado_pieza').value = '';
      document.getElementById('traslado_destino').value = '';
      document.getElementById('traslado_cantidad').value = '';
      volverPaso1Traslado();
      
      mostrarUbicacionesTraslado();
      actualizarUIDesdeMovimiento();

    } catch (e) {
      showCustomAlert('‚ùå Error de Transacci√≥n', 'Error: ' + e.message);
    } finally {
      hideLoader(); // <-- APAGAR
    }
  }
  
  // BUG FIX #3: Implementar agrupaci√≥n y suma para el buscador
  function buscarInventario() {
    const resultadosDiv = document.getElementById('resultadosBusqueda');
    if (!resultadosDiv) return;

    let termino = '';
    if (state.buscarPor === 'pieza')  termino = document.getElementById('busquedaPieza')?.value.trim() || '';
    else                              termino = document.getElementById('busquedaUbicacion')?.value.trim() || '';
    if (!termino) {
      resultadosDiv.innerHTML = '<p class="text-center py-4 text-sm" style="color: var(--color-text-secondary);">Ingresa un t√©rmino de b√∫squeda</p>';
      return;
    }
    
    // 1. Obtener los resultados no agrupados
    const inventarioBruto = (state.buscarPor === 'pieza')
      ? Store.getInventory(state.store, termino)
      : Store.getInventory(state.store, undefined, termino);

    // 2. Agrupar por Pieza y Ubicaci√≥n (solo para el caso de b√∫squeda por pieza, si no, ya est√° impl√≠cito)
    const agrupadoMap = new Map();

    inventarioBruto.forEach(item => {
        const key = `${item.itemCode}-${item.locationQR}`;
        if (agrupadoMap.has(key)) {
            const existing = agrupadoMap.get(key);
            existing.quantity += item.quantity;
            agrupadoMap.set(key, existing);
        } else {
            agrupadoMap.set(key, { ...item });
        }
    });

    const resultados = Array.from(agrupadoMap.values());
    
    // 3. Mostrar resultados agrupados
    if (resultados.length === 0) {
      resultadosDiv.innerHTML = '<p class="text-center py-4 text-sm" style="color: var(--color-text-secondary);">Sin resultados</p>';
      return;
    }
    resultadosDiv.innerHTML = `
      <div class="space-y-2">
        ${resultados.map(item => `
          <div class="card-minimal rounded-lg p-3">
            <p class="font-semibold" style="color: var(--color-text);">${item.itemCode}</p>
            <p class="text-sm" style="color: var(--color-text-secondary);">Ubicaci√≥n: ${item.locationQR}</p>
            <p class="text-sm text-lg font-bold" style="color: var(--color-text);">Cantidad: ${item.quantity} uds</p>
            ${item.itemDescription ? `<p class="text-sm" style="color: var(--color-text-secondary);">${item.itemDescription}</p>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function obtenerHistorial() {
    let movimientos = [...state.store.movements];
    movimientos.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    if (state.historialFiltro === 'entradas') movimientos = movimientos.filter(m => m.type === 'IN');
    else if (state.historialFiltro === 'salidas') movimientos = movimientos.filter(m => m.type === 'OUT');
    else if (state.historialFiltro === 'traslados') movimientos = movimientos.filter(m => m.type === 'TRANSFER');
    else if (state.historialFiltro === 'ajustes') movimientos = movimientos.filter(m => m.type === 'ADJUST'); // <-- L√çNEA A√ëADIDA
    if (state.historialBusqueda) {
      const termino = state.historialBusqueda.toLowerCase();
      movimientos = movimientos.filter(m =>
        m.itemCode.toLowerCase().includes(termino) ||
        (m.toLocationQR   && m.toLocationQR.toLowerCase().includes(termino)) ||
        (m.fromLocationQR && m.fromLocationQR.toLowerCase().includes(termino)) ||
        (m.workOrderCode  && m.workOrderCode.toLowerCase().includes(termino))
      );
    }
    return movimientos;
  }

  function mostrarModalEnvio(workOrderCode) {
    const wo = state.store.workOrders.find(w => w.code === workOrderCode);
    if (!wo) return;
    const stockDisponible = Store.getInventory(state.store, wo.itemCode);
    const totalStock = stockDisponible.reduce((sum, item) => sum + item.quantity, 0);
    if (totalStock === 0) {
      showCustomAlert('‚ùå Error', 'Sin stock disponible');
      return;
    }
    state.enviandoWorkOrder = { wo, stockDisponible, totalStock };
    renderModalsContainer(); 
  }

  function cerrarModalEnvio() {
    state.enviandoWorkOrder = null;
    renderModalsContainer(); 
  }

 // ... (cuerpo de la funci√≥n)

  async function procesarEnvioDesdeOF() {
    const { wo, stockDisponible } = state.enviandoWorkOrder;
    if (!wo) return;

    const picks = [];
    let totalEnviar = 0;
    try {
      stockDisponible.forEach((item, index) => {
        const input = document.getElementById(`envio_cantidad_${index}`);
        const cantidad = parseInt(input.value) || 0;
        if (cantidad > 0) {
          if (cantidad > item.quantity) {
            throw new Error(`En ${item.locationQR} solo hay ${item.quantity} uds`);
          }
          picks.push({ locationQR: item.locationQR, quantity: cantidad });
          totalEnviar += cantidad;
        }
      });
    } catch(e) {
      showCustomAlert('‚ùå Error', 'Error en las cantidades: ' + e.message);
      return;
    }
    
    if (picks.length === 0) { 
        showCustomAlert('‚ö†Ô∏è Advertencia', 'Ingresa al menos una cantidad a enviar');
        return; 
    }

    const pendienteEnviar = wo.quantitySolicited - wo.quantityShipped;
    
    // --- INICIO DE LA CORRECCI√ìN ESTRICTA (FIX v20.7) ---
    if (totalEnviar > pendienteEnviar) {
      showCustomAlert('‚ùå Error de Env√≠o', `La cantidad total a enviar (${totalEnviar} uds) excede estrictamente las ${pendienteEnviar} uds pendientes para la OF ${wo.code}. Por favor, corrige la cantidad.`);
      return; // <--- BLOQUEO ESTRICTO
    }
    // --- FIN DE LA CORRECCI√ìN ESTRICTA ---
    
    showLoader(); // <-- ENCENDER
    try {
        await Store.removeStockSplit(wo.itemCode, picks, wo.code);
        
        // ... (l√≥gica de alerts) ...
        const nuevoTotalEnviado = wo.quantityShipped + totalEnviar; 
        const woActualizada = state.store.workOrders.find(w => w.code === wo.code); 
        
        if (woActualizada && woActualizada.status === 'COMPLETADA') {
          showCustomAlert('‚úÖ Env√≠o Registrado', `Orden completada: ${nuevoTotalEnviado} uds enviadas.`);
        } else {
          showCustomAlert('‚úÖ √âxito', `Env√≠o registrado: ${totalEnviar} uds`);
        }
        
        cerrarModalEnvio();
        actualizarUIDesdeMovimiento();
        if (state.activeTab === 'ordenes') renderContenido();

    } catch(e) {
        showCustomAlert('‚ùå Error de Transacci√≥n', 'Error: ' + e.message);
    } finally {
        hideLoader(); // <-- APAGAR
    }
  }

  function getDashboardData() {
    // ... (L√≥gica de dashboard)
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    const totalUnidades = state.store.inventory.reduce((sum, i) => sum + (i.quantity || 0), 0);
    const ubicacionesOcupadas = new Set(state.store.inventory.map(i => i.locationId)).size;
    const totalUbicaciones = state.store.locations.length;
    const ordenesPendientes = state.store.workOrders.filter(w => w.status === 'PENDIENTE').length;
    const movimientosHoy = state.store.movements.filter(m => new Date(m.createdAt) >= hoy);
    const entradasHoy = movimientosHoy.filter(m => m.type === 'IN').reduce((sum, m) => sum + m.quantity, 0);
    const salidasHoy = movimientosHoy.filter(m => m.type === 'OUT').reduce((sum, m) => sum + m.quantity, 0);
    const tasaCumplimiento = (entradasHoy === 0) ? (salidasHoy > 0 ? 100 : 0) : Math.min(Math.round((salidasHoy / entradasHoy) * 100), 100);
    const tendencia = { labels: [], entradas: [], salidas: [] };
    for (let i = 6; i >= 0; i--) {
      const fecha = new Date();
      fecha.setDate(fecha.getDate() - i);
      const diaStr = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
      tendencia.labels.push(diaStr);
      const inicioDia = new Date(fecha).setHours(0, 0, 0, 0);
      const finDia = new Date(fecha).setHours(23, 59, 59, 999);
      const movsDia = state.store.movements.filter(m => {
        const fechaMov = new Date(m.createdAt).getTime();
        return fechaMov >= inicioDia && fechaMov <= finDia;
      });
      tendencia.entradas.push(movsDia.filter(m => m.type === 'IN').reduce((sum, m) => sum + m.quantity, 0));
      tendencia.salidas.push(movsDia.filter(m => m.type === 'OUT').reduce((sum, m) => sum + m.quantity, 0));
    }
    const estadoOrdenes = {
      'PENDIENTE': 0, 'PRODUCCION_COMPLETA': 0, 'ENVIO_PARCIAL': 0, 'COMPLETADA': 0
    };
    state.store.workOrders.forEach(wo => {
      if (estadoOrdenes.hasOwnProperty(wo.status)) {
        estadoOrdenes[wo.status]++;
      }
    });
    const estadoOrdenesData = {
      labels: ["Pendiente", "Prod. Completa", "Env√≠o Parcial", "Completada"],
      cantidades: [
        estadoOrdenes['PENDIENTE'],
        estadoOrdenes['PRODUCCION_COMPLETA'],
        estadoOrdenes['ENVIO_PARCIAL'],
        estadoOrdenes['COMPLETADA']
      ]
    };
    const ordenesFabricacionData = state.store.workOrders
      .filter(wo => wo.status !== 'COMPLETADA')
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .slice(0, 5)
      .map(wo => {
        let progreso = 0;
        if (wo.quantitySolicited > 0) {
          progreso = Math.round((wo.quantityProduced / wo.quantitySolicited) * 100);
        }
        let color = 'var(--color-yellow-accent)';
        if (wo.status === 'PRODUCCION_COMPLETA') color = 'var(--color-blue-accent)';
        if (wo.status === 'ENVIO_PARCIAL') color = 'var(--color-purple-accent)';
        return {
          id: wo.code, pieza: wo.itemCode,
          progreso: Math.min(progreso, 100),
          estado: wo.status, color: color
        };
      });
    const stockUbicacionMap = new Map();
    state.store.inventory.forEach(invRow => {
      const location = state.store.locationsMap.get(invRow.locationId);
      if (!location) return;
      const key = location.qr;
      if (!stockUbicacionMap.has(key)) {
        stockUbicacionMap.set(key, { locationQR: key, piezas: new Set(), totalUds: 0 });
      }
      const data = stockUbicacionMap.get(key);
      data.piezas.add(invRow.itemId);
      data.totalUds += invRow.quantity;
    });
    const stockUbicacionData = Array.from(stockUbicacionMap.values())
      .sort((a, b) => b.totalUds - a.totalUds)
      .slice(0, 5)
      .map(item => ({
        locationQR: item.locationQR,
        piezasCount: item.piezas.size,
        totalUds: item.totalUds
      }));
    const actividadData = state.store.movements
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .slice(0, 8)
      .map(mov => ({
        tipo: mov.type, pieza: mov.itemCode, cant: mov.quantity,
        ubic: mov.type === 'IN' ? mov.toLocationQR : (mov.type === 'OUT' ? mov.fromLocationQR : `${mov.fromLocationQR} ‚Üí ${mov.toLocationQR}`),
        user: mov.createdBy,
        time: new Date(mov.createdAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
      }));
    return {
      kpis: {
        totalUnidades: totalUnidades.toLocaleString('es-ES'),
        ubicacionesOcupadas: ubicacionesOcupadas,
        totalUbicaciones: totalUbicaciones,
        ordenesPendientes: ordenesPendientes,
        tasaCumplimiento: tasaCumplimiento
      },
      tendenciaData: tendencia,
      estadoOrdenesData: estadoOrdenesData,
      ordenesFabricacionData: ordenesFabricacionData,
      stockUbicacionData: stockUbicacionData,
      actividadData: actividadData
    };
  }

  function actualizarUIDesdeMovimiento() {
    buildStoreMaps(state.store);
    renderDatalistsContainer(); 
    
    if (state.activeTab === 'inicio') {
      const dashboardData = getDashboardData();
      llenarKPIs(dashboardData.kpis);
      renderActividadReciente(dashboardData.actividadData);
      renderOrdenesFabricacion(dashboardData.ordenesFabricacionData);
      renderStockUbicacion(dashboardData.stockUbicacionData);
      try {
        initTendenciaChart(dashboardData.tendenciaData);
        initEstadoOrdenesChart(dashboardData.estadoOrdenesData);
      } catch(e) {
        console.error("Error al actualizar los gr√°ficos:", e);
      }
    }
  }

  function getPiezasSinOrden() {
    const todasLasPiezas = {};
    
    // 1. Agrupar el inventario por Pieza y Ubicaci√≥n QR (Fix de duplicaci√≥n visual)
    state.store.inventory.forEach(invRow => {
      const item = state.store.itemsMap.get(invRow.itemId);
      const location = state.store.locationsMap.get(invRow.locationId);
      if (!item || !location) return;
      
      const itemCode = item.code;
      const locationQR = location.qr;
      
      if (!todasLasPiezas[itemCode]) {
        todasLasPiezas[itemCode] = { 
          itemCode: itemCode, 
          totalStock: 0, 
          ubicaciones: new Map() // Usamos Map para agrupar por QR
        };
      }
      
      todasLasPiezas[itemCode].totalStock += invRow.quantity;
      
      // Agrupaci√≥n y suma por Ubicaci√≥n QR
      const currentQty = todasLasPiezas[itemCode].ubicaciones.get(locationQR) || 0;
      todasLasPiezas[itemCode].ubicaciones.set(locationQR, currentQty + invRow.quantity);
    });

    // 2. Calcular el stock que entr√≥ SIN orden (IN - OUT sin orden)
    const entradasSinOrden = state.store.movements.filter(m => m.type === 'IN' && !m.workOrderCode);
    const piezasSinOrden = {};
    
    entradasSinOrden.forEach(mov => {
      if (!piezasSinOrden[mov.itemCode]) {
        piezasSinOrden[mov.itemCode] = { itemCode: mov.itemCode, totalSinOrden: 0 };
      }
      piezasSinOrden[mov.itemCode].totalSinOrden += mov.quantity;
    });
    
    const salidasSinOrden = state.store.movements.filter(m => m.type === 'OUT' && !m.workOrderCode);
    
    salidasSinOrden.forEach(mov => {
      if (piezasSinOrden[mov.itemCode]) {
        piezasSinOrden[mov.itemCode].totalSinOrden -= mov.quantity;
      }
    });

    // 3. Formatear el resultado final, agregando las ubicaciones agrupadas
    const finalResult = [];
    Object.keys(piezasSinOrden).forEach(itemCode => {
      if (piezasSinOrden[itemCode].totalSinOrden > 0) {
        
        const piezaData = todasLasPiezas[itemCode];
        if (piezaData) {
            
            // Convertir el Map de ubicaciones agrupadas a un array para la vista
            const ubicacionesAgrupadas = Array.from(piezaData.ubicaciones.entries()).map(([qr, qty]) => ({
                locationQR: qr,
                quantity: qty
            }));

            const stockMaximo = piezaData.totalStock;
            const stockSinOrden = Math.min(piezasSinOrden[itemCode].totalSinOrden, stockMaximo);

            finalResult.push({
                itemCode: itemCode,
                totalSinOrden: stockSinOrden,
                ubicaciones: ubicacionesAgrupadas,
                totalStock: stockMaximo
            });
        }
      }
    });
    
    return finalResult;
  }
  
  // =========================================================================
  // FUNCIONES DE RENDERIZADO DE LA INTERFAZ
  // =========================================================================

  function getTituloPagina() {
    const titulos = {
      'inicio': 'Dashboard', 'entrada': 'Entrada de Inventario', 'salida': 'Salida de Inventario',
      'traslados': 'Traslados', 'buscar': 'Buscar en Inventario', 'ordenes': '√ìrdenes de Fabricaci√≥n',
      'historial': 'Historial de Movimientos', 'usuarios': 'Gesti√≥n de Usuarios',
      'catalogos': 'Gesti√≥n de Cat√°logos', // <-- NUEVO
      'ajuste': 'Ajuste de Inventario' // <-- NUEVO (Para Fase 2)
    };
    return titulos[state.activeTab] || 'Dashboard';
  }

  function getIcono(id) {
    const iconos = {
      'inicio': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1zm5 0a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>',
      'entrada': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
      'salida': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>',
      'traslados': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>',
      'buscar': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>',
      'ordenes': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>',
      'historial': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
      'usuarios': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
     'catalogos': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>', // <-- NUEVO
      'ajuste': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>', // <-- NUEVO ICONO
    };
    return iconos[id] || '';
  }

  function getTabs() {
    const tabs = [
      { id: 'inicio', label: 'Dashboard' }, { id: 'entrada', label: 'Entrada' },
      { id: 'salida', label: 'Salida' }, { id: 'traslados', label: 'Traslados' },
      { id: 'buscar', label: 'Buscar' }, { id: 'ordenes', label: '√ìrdenes' },
      { id: 'historial', label: 'Historial' }
    ];
    // Se agregan Cat√°logos y Ajuste para Admin
    if (state.currentUser.role === 'admin') {
      tabs.push({ id: 'catalogos', label: 'Cat√°logos' }); // <-- NUEVO
      tabs.push({ id: 'ajuste', label: 'Ajuste' }); // <-- NUEVO
      tabs.push({ id: 'usuarios', label: 'Usuarios' });
    }
    return tabs;
  }
  
  function cambiarPestana(tabId) {
    state.activeTab = tabId;
    renderContenido(); 
  }

  function renderSidebar() {
    const tabs = getTabs();
    return `
      <div class="flex flex-col h-full">
        <div class="flex items-center gap-3 h-16 px-6 border-b" style="border-color: var(--color-border);">
          <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
          </div>
          <h1 class="text-lg font-bold" style="color: var(--color-text);">Sistema Log√≠stica</h1>
        </div>
        <nav id="sidebar-nav" class="flex-1 p-4 space-y-2">
          ${tabs.map(tab => `
            <button onclick="cambiarPestana('${tab.id}')"
              id="tab-btn-sidebar-${tab.id}"
              class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${state.activeTab === tab.id ? 'bg-blue-600 text-white shadow' : 'hover:bg-gray-500/10'}"
              style="${state.activeTab !== tab.id ? 'color: var(--color-text);' : ''}">
              ${getIcono(tab.id)}
              <span>${tab.label}</span>
            </button>
          `).join('')}
        </nav>
        <div class="p-4 border-t" style="border-color: var(--color-border);">
          <button onclick="handleLogout()" 
            class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition hover:bg-gray-500/10"
            style="color: var(--color-text-secondary);">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            <span>Cerrar Sesi√≥n</span>
          </button>
        </div>
      </div>
    `;
  }

  function renderMobileNav() {
    const tabs = getTabs();
    const row1 = tabs.slice(0, 4);
    const row2 = tabs.slice(4);
    const renderRow = (row) => row.map(tab => `
      <button onclick="cambiarPestana('${tab.id}')"
        id="tab-btn-mobile-${tab.id}"
        class="flex-1 py-2 px-2 rounded-md text-sm font-medium transition ${state.activeTab === tab.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-500/10'}"
        style="${state.activeTab !== tab.id ? 'color: var(--color-text);' : ''}">
        ${tab.label}
      </button>
    `).join('');
    return `
      <div id="mobile-nav" class="card-minimal rounded-lg p-1 space-y-1">
        <div class="flex gap-1">
          ${renderRow(row1)}
        </div>
        ${row2.length > 0 ? `
          <div class="flex gap-1">
            ${renderRow(row2)}
          </div>
        ` : ''}
      </div>
    `;
  }
  
  function renderHeader() {
    const temaLabel = state.theme === 'light' ? '‚òÄÔ∏è' : state.theme === 'semi-dark' ? 'üåó' : 'üåô';
    return `
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <h1 id="page-title" class="text-lg font-bold hidden md:block" style="color: var(--color-text);">${getTituloPagina()}</h1>
          <div class="flex items-center gap-3 md:hidden">
            <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <div>
              <h1 class="text-lg font-bold" style="color: var(--color-text);">Log√≠stica</h1>
              <p class="text-xs" style="color: var(--color-text-secondary);">${state.currentUser.nombre_completo}</p>
            </div>
          </div>
          <div class="flex gap-2 items-center">
            <span class="text-sm hidden md:inline" style="color: var(--color-text-secondary);">${state.currentUser.nombre_completo}</span>
            <button id="theme-toggle-button" onclick="cambiarTema()" class="p-2 rounded-lg" title="Cambiar tema" style="color: var(--color-text); background: none; border: none; cursor: pointer;">
              ${temaLabel}
            </button>
            <button onclick="exportarJSON()" class="px-3 py-2 text-sm hover:bg-gray-500/10 rounded-lg transition" style="color: var(--color-text); background: none; border: none; cursor: pointer;">Exportar</button>
            <button onclick="triggerImport()" class="px-3 py-2 text-sm hover:bg-gray-500/10 rounded-lg transition" style="color: var(--color-text); background: none; border: none; cursor: pointer;">Importar</button>
            <button onclick="handleLogout()" class="px-3 py-2 text-sm hover:bg-gray-500/10 rounded-lg transition md:hidden" style="color: var(--color-text); background: none; border: none; cursor: pointer;" title="Cerrar Sesi√≥n">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderAppShell() {
    return `
      <nav class="fixed inset-y-0 left-0 w-64 z-20 shadow-lg hidden md:block" style="background-color: var(--color-bg-card); border-right: 1px solid var(--color-border);">
        ${renderSidebar()}
      </nav>
      <div id="app-shell" class="md:pl-64 min-h-screen" style="background-color: var(--color-bg);">
        <header class="sticky top-0 z-10 border-b shadow-sm" style="background-color: var(--color-bg-card); border-color: var(--color-border);">
          ${renderHeader()}
        </header>
        <nav class="p-4 md:hidden">
          ${renderMobileNav()}
        </nav>
        <main id="app-content" class="max-w-7xl mx-auto p-4 pt-0 md:pt-4">
          <!-- El contenido de la pesta√±a se insertar√° aqu√≠ -->
        </main>
      </div>
      
      <!-- Contenedores para elementos din√°micos fuera del main -->
      <div id="modals-container"></div>
      <div id="datalists-container"></div>
    `;
  }

  function render() {
    const app = document.getElementById('app');
    if (!state.isAuthenticated) {
      app.innerHTML = renderLogin();
      return;
    }
    
    if (!document.getElementById('app-shell')) {
      app.innerHTML = renderAppShell();
    }
    
    renderContenido(); 
    renderDatalistsContainer(); 
    
    aplicarTema();
  }

  function renderContenido() {
    const contentEl = document.getElementById('app-content');
    if (!contentEl) {
      console.error("Error: Contenedor 'app-content' no encontrado.");
      return;
    }

    renderModalsContainer();

    if (state.activeTab !== 'inicio') {
      if (state.charts.tendencia) state.charts.tendencia.destroy();
      if (state.charts.estadoOrdenes) state.charts.estadoOrdenes.destroy();
      state.charts.tendencia = null;
      state.charts.estadoOrdenes = null;
    }
    
    let content = '';
    if (state.activeTab === 'inicio')       content = renderInicio();
    else if (state.activeTab === 'entrada')  content = renderEntrada();
    else if (state.activeTab === 'salida')   content = renderSalida();
    else if (state.activeTab === 'traslados') content = renderTraslados();
    else if (state.activeTab === 'buscar')   content = renderBuscar();
    else if (state.activeTab === 'ordenes')  content = renderOrdenes();
    else if (state.activeTab === 'historial') content = renderHistorial();
    else if (state.activeTab === 'catalogos') content = renderCatalogos(); 
    else if (state.activeTab === 'ajuste') content = renderAjuste(); 
    else if (state.activeTab === 'usuarios') content = renderUsuarios();

    contentEl.innerHTML = `<div class="fade-in">${content}</div>`;
    
    const tabs = getTabs();
    tabs.forEach(tab => {
      const btnSidebar = document.getElementById(`tab-btn-sidebar-${tab.id}`);
      const btnMobile = document.getElementById(`tab-btn-mobile-${tab.id}`);
      const isActive = state.activeTab === tab.id;
      
      if (btnSidebar) {
        btnSidebar.className = `w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${isActive ? 'bg-blue-600 text-white shadow' : 'hover:bg-gray-500/10'}`;
        btnSidebar.style.color = isActive ? '' : 'var(--color-text)';
      }
      if (btnMobile) {
        btnMobile.className = `flex-1 py-2 px-2 rounded-md text-sm font-medium transition ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-500/10'}`;
        btnMobile.style.color = isActive ? '' : 'var(--color-text)';
      }
    });
    
    const titleEl = document.getElementById('page-title');
    if (titleEl) titleEl.textContent = getTituloPagina();
    
    if (state.activeTab === 'inicio') {
      aplicarTema();
      const dashboardData = getDashboardData();
      mostrarFecha();
      llenarKPIs(dashboardData.kpis);
      renderActividadReciente(dashboardData.actividadData);
      renderOrdenesFabricacion(dashboardData.ordenesFabricacionData);
      renderStockUbicacion(dashboardData.stockUbicacionData);
      try {
        initTendenciaChart(dashboardData.tendenciaData);
        initEstadoOrdenesChart(dashboardData.estadoOrdenesData);
      } catch(e) {
        console.error("Error al iniciar los gr√°ficos:", e);
      }
    }
  }
  
  function renderDatalistsContainer() {
    const container = document.getElementById('datalists-container');
    if (container) {
      container.innerHTML = renderAllDatalists();
    }
  }

  function renderAllDatalists() {
    // ¬°NUEVO! Filtramos las piezas que NO est√°n archivadas
    const piezasOptions = state.store.items
      .filter(item => item.status !== 'archivado') 
      .map(item => `<option value="${item.code}"></option>`)
      .join('');
    
    const ubicacionesOptions = state.store.locations.map(loc => 
      `<option value="${loc.qr}"></option>`
    ).join('');
    
    return `
      <datalist id="piezas-list">
        ${piezasOptions}
      </datalist>
      <datalist id="ubicaciones-list">
        ${ubicacionesOptions}
      </datalist>
    `;
  }
  
  function renderAllModals() {
    return `
    ${state.isLoading ? `
        <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex flex-col items-center justify-center p-4" style="backdrop-filter: blur(2px);">
          <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-white text-lg font-semibold">Procesando...</p>
        </div>
      ` : ''}

      <div id="scannerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) cerrarScanner()">
        <div class="rounded-lg w-full max-w-md shadow-xl" style="background-color: var(--color-bg-card);">
          <div class="flex justify-between items-center p-4 border-b" style="border-color: var(--color-border);">
            <h3 class="font-semibold" style="color: var(--color-text);">Escanear QR</h3>
            <button onclick="event.stopPropagation(); cerrarScanner();" class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center">&times;</button>
          </div>
          <div class="p-4">
            <div id="qr-reader" class="rounded-lg overflow-hidden"></div>
            <p class="text-sm mt-3 text-center" style="color: var(--color-text-secondary);">Apunta la c√°mara al c√≥digo QR</p>
          </div>
          <div class="p-4 border-t" style="border-color: var(--color-border);">
            <button onclick="event.stopPropagation(); cerrarScanner();" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Cancelar</button>
          </div>
        </div>
      </div>
      
      <!-- Nuevo Modal de Alerta/Error Personalizado -->
      <div id="customAlertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-lg w-full max-w-md shadow-xl overflow-hidden" onclick="event.stopPropagation()">
              <div class="p-6 text-center">
                  <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-red-100 mb-4">
                      <svg id="alertIcon" class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.303 16c-.77 1.333.192 3 1.732 3z"/></svg>
                  </div>
                  <h3 id="customAlertTitle" class="text-lg font-semibold text-gray-900 mb-2">Atenci√≥n</h3>
                  <p id="customAlertMessage" class="text-sm text-gray-500">Mensaje de prueba.</p>
              </div>
              <div id="alertButtonContainer" class="p-4 bg-gray-50 border-t flex justify-center">
                  <button onclick="closeCustomAlert()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-medium transition">Aceptar</button>
              </div>
          </div>
      </div>
      <!-- Fin Modal de Alerta/Error Personalizado -->

      ${state.showExcesoModal ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="card-minimal rounded-lg w-full max-w-md shadow-xl">
            <div class="bg-amber-500 p-4 rounded-t-lg"><h3 class="font-semibold text-white">Exceso de Producci√≥n</h3></div>
            <div class="p-6 space-y-4">
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm space-y-1">
                <p class="text-amber-900"><strong>Orden:</strong> ${state.excesoData.orden}</p>
                <p class="text-amber-900"><strong>Pieza:</strong> ${state.excesoData.pieza}</p>
                <p class="text-amber-900"><strong>Solicitado:</strong> ${state.excesoData.solicitado} uds</p>
                <p class="text-amber-900"><strong>Ya producido:</strong> ${state.excesoData.producido} uds</p>
                <p class="text-amber-900"><strong>Intentas agregar:</strong> ${state.excesoData.cantidad} uds</p>
                <hr class="border-amber-300 my-2">
                <p class="font-semibold text-amber-800"><strong>Faltan para completar:</strong> ${state.excesoData.cantidadParaCompletar} uds</p>
                <p class="font-semibold text-red-700"><strong>Exceso:</strong> ${state.excesoData.exceso} uds</p>
              </div>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs">
                <p class="font-semibold text-blue-900 mb-1">Se har√° lo siguiente:</p>
                <p class="text-blue-800">1. Se cargar√°n <strong>${state.excesoData.cantidadParaCompletar} uds</strong> en la orden <strong>${state.excesoData.orden}</strong> para completarla</p>
                <p class="text-blue-800 mt-1">2. Las <strong>${state.excesoData.exceso} uds</strong> restantes se cargar√°n donde elijas</p>
              </div>
              <p class="text-sm" style="color: var(--color-text);">¬øD√≥nde deseas cargar las <strong>${state.excesoData.exceso} uds</strong> restantes?</p>
              <div class="space-y-2">
                <button onclick="cargarEnOtraOrden()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition">Cargar en Otra Orden</button>
                <button onclick="cargarSinOrden()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg font-medium transition">Cargar Sin Orden</button>
                <button onclick="cerrarModalExceso()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Cancelar</button>
              </div>
            </div>
          </div>
        </div>
      ` : ''}

      ${state.creatingWorkOrder ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="card-minimal rounded-lg w-full max-w-md shadow-xl">
            <div class="bg-blue-600 p-4 rounded-t-lg"><h3 class="font-semibold text-white">Nueva Orden de Fabricaci√≥n</h3></div>
            <div class="p-6 space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                <p class="text-blue-900"><strong>C√≥digo:</strong> ${state.pendingWorkOrderData.orden}</p>
                <p class="text-blue-900"><strong>Pieza:</strong> ${state.pendingWorkOrderData.pieza}</p>
                <p class="text-blue-900"><strong>Primera producci√≥n:</strong> ${state.pendingWorkOrderData.cantidad} uds (Se registrar√°n en Firestore)</p>
              </div>
              <div>
                <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Cantidad Total Solicitada *</label>
                <input type="number" id="of_cantidad_solicitada" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="200" min="${state.pendingWorkOrderData.cantidad}" value="${state.pendingWorkOrderData.cantidad}">
              </div>
              <div>
                <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Descripci√≥n (opcional)</label>
                <textarea id="of_descripcion" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Pedido cliente..."></textarea>
              </div>
              <div class="flex gap-3">
                <button onclick="cancelarNuevaOF()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Cancelar</button>
                <button onclick="crearNuevaOF()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition">Crear Orden</button>
              </div>
            </div>
          </div>
        </div>
      ` : ''}

      ${state.editingMovement ? `
        <div id="editMovementModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="card-minimal rounded-lg w-full max-w-md shadow-xl">
            <div class="bg-amber-500 p-4 rounded-t-lg">
              <h3 class="font-semibold text-white">Editar Movimiento</h3>
              <p class="text-sm text-amber-100">Solo administradores</p>
            </div>
            <div class="p-6 space-y-4">
              <input type="hidden" id="edit_movement_id" value="${state.editingMovement.id}">
              <div id="edit_movement_info" class="border rounded-lg p-3" style="background-color: var(--color-bg); color: var(--color-text); border-color: var(--color-border);">
                <p class="text-sm"><strong>Pieza:</strong> ${state.editingMovement.itemCode}</p>
                <p class="text-sm"><strong>Tipo:</strong> ${state.editingMovement.type === 'IN' ? 'Entrada' : state.editingMovement.type === 'OUT' ? 'Salida' : 'Traslado'}</p>
                <p class="text-sm"><strong>Cantidad actual:</strong> ${state.editingMovement.quantity} uds</p>
              </div>
              <div>
                <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Nueva Cantidad *</label>
                <input type="number" id="edit_movement_quantity" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" min="1" value="${state.editingMovement.quantity}">
              </div>
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-3"><p class="text-xs text-amber-800">Esta acci√≥n modificar√° el inventario, la Orden de Fabricaci√≥n (si aplica) y quedar√° marcada como una correcci√≥n de administrador.</p></div>
              <div class="flex gap-3">
                <button onclick="cerrarModalEditarMovimiento()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Cancelar</button>
                <button onclick="guardarEdicionMovimiento()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-2 rounded-lg font-medium transition">Guardar Edici√≥n</button>
              </div>
            </div>
          </div>
        </div>
      ` : ''}

      ${state.enviandoWorkOrder ? `
        <div id="envioModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="card-minimal rounded-lg w-full max-w-lg shadow-xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-green-600 p-4 rounded-t-lg z-10"><h3 class="font-semibold text-white">Enviar Stock</h3></div>
            <div class="p-6 space-y-4">
              <input type="hidden" id="envio_wo_code" value="${state.enviandoWorkOrder.wo.code}">
              <div id="envio_info">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3 text-sm">
                  <p class="font-semibold text-blue-900">Orden: ${state.enviandoWorkOrder.wo.code}</p>
                  <p class="text-blue-700">Pieza: ${state.enviandoWorkOrder.wo.itemCode}</p>
                  <p class="text-blue-700">Solicitado: ${state.enviandoWorkOrder.wo.quantitySolicited} uds</p>
                  <p class="text-blue-700">Enviado: ${state.enviandoWorkOrder.wo.quantityShipped} uds</p>
                  <p class="font-semibold text-blue-800">Pendiente: ${state.enviandoWorkOrder.wo.quantitySolicited - state.enviandoWorkOrder.wo.quantityShipped} uds</p>
                  <p class="font-semibold text-green-700">Stock: ${state.enviandoWorkOrder.totalStock} uds</p>
                </div>
              </div>
              <div id="envio_ubicaciones_list">
                <h3 class="font-medium text-sm mb-2" style="color: var(--color-text);">Selecciona Ubicaciones</h3>
                ${state.enviandoWorkOrder.stockDisponible.map((item, index) => `
                  <div class="card-minimal rounded-lg p-3 mb-2">
                    <p class="font-semibold" style="color: var(--color-text);">${item.locationQR}</p>
                    <p class="text-sm mb-2" style="color: var(--color-text-secondary);">Disponible: ${item.quantity} uds</p>
                    <input 
                      type="number" 
                      id="envio_cantidad_${index}" 
                      data-ubicacion="${item.locationQR}"
                      data-disponible="${item.quantity}"
                      class="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 text-sm" 
                      style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);"
                      placeholder="Cantidad"
                      min="0" max="${item.quantity}">
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="flex gap-3 sticky bottom-0 p-4 border-t z-0" style="background-color: var(--color-bg-card); border-color: var(--color-border);">
              <button onclick="cerrarModalEnvio()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Cancelar</button>
              <button onclick="procesarEnvioDesdeOF()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium transition">Confirmar Env√≠o</button>
            </div>
          </div>
        </div>
      ` : ''}

      ${state.showVerificarItemModal ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="card-minimal rounded-lg w-full max-w-md shadow-xl">
            <div class="bg-blue-600 p-4 rounded-t-lg">
              <h3 class="font-semibold text-white">Gestionar Pieza</h3>
            </div>
            ${!state.verificandoItemData ? `
              <div class="p-6 text-center">
                <p style="color: var(--color-text);">Verificando...</p>
              </div>
            ` : `
              <div class="p-6 space-y-4">
                <div class="border rounded-lg p-3" style="background-color: var(--color-bg); color: var(--color-text); border-color: var(--color-border);">
                  <p class="text-sm"><strong>Pieza:</strong> ${state.verificandoItemData.itemCode}</p>
                </div>
                <div class="grid grid-cols-1 gap-2 text-center">
                  <div class="rounded-md p-2" style="background-color: var(--color-bg);">
                    <p class="text-xs" style="color: var(--color-text-secondary);">Stock Total Actual</p>
                    <p class="text-lg font-bold ${state.verificandoItemData.stock > 0 ? 'text-red-500' : 'text-green-500'}">${state.verificandoItemData.stock} uds</p>
                  </div>
                </div>
                
                ${state.verificandoItemData.isSafeToArchive ? `
                  <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-xs text-green-800">
                    <p>Esta pieza tiene 0 stock y puede ser archivada de forma segura.</p>
                    <p class="mt-1">Al archivarla, se ocultar√° de todos los men√∫s desplegables.</p>
                  </div>
                  <button onclick="confirmarArchivadoItem()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition">Archivar Pieza</button>
                ` : `
                  <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-xs text-amber-800">
                    <p><strong>No se puede archivar.</strong></p>
                    <p class="mt-1">Esta pieza todav√≠a tiene <strong>${state.verificandoItemData.stock} uds</strong> en stock.</p>
                    <p class="mt-2">Por favor, usa la pesta√±a <strong>"Ajuste"</strong> para poner el stock en 0 antes de archivarla.</p>
                  </div>
                `}
                
                <button onclick="cerrarModalGestionarItem()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Cerrar</button>
              </div>
            `}
          </div>
        </div>
      ` : ''}
    `; 
}

  
  function renderModalsContainer() {
    const container = document.getElementById('modals-container');
    if (container) {
      container.innerHTML = renderAllModals();
    }
  }

  function renderLogin() {
    return `
      <div class="min-h-screen bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-10">
          <div class="text-center mb-8">
            <div class="bg-blue-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-5">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Log√≠stica ERCA</h1>
            <p class="text-gray-500 text-sm">v20.7 - Fix Validaci√≥n OF</p>
          </div>
          
          <form onsubmit="handleLogin(event)" class="space-y-5">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input 
                type="text" 
                id="username" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900" 
                placeholder="admin@erca.com o operario@erca.com"
                required>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
              <input 
                type="password" 
                id="password" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                required>
            </div>
            
            <button 
              type="submit" 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3.5 rounded-lg transition-all transform hover:scale-[1.02] shadow-lg">
              Iniciar Sesi√≥n
            </button>
          </form>
        </div>
      </div>
    `;
  }

  function renderInicio() {
    const dashboardData = getDashboardData();
    return `
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold" style="color: var(--color-text);">Bienvenido, ${state.currentUser.nombre_completo}</h2>
          <p id="current-date" class="text-sm" style="color: var(--color-text-secondary);"></p>
        </div>
        <div class="dashboard-grid">
          <div class="bi-card kpi-card">
            <p class="text-sm font-medium" style="color: var(--color-text-secondary);">Inventario Total</p>
            <p id="kpi-total-unidades" class="text-3xl font-bold" style="color: var(--color-blue-accent);">${dashboardData.kpis.totalUnidades}</p>
            <p class="text-sm" style="color: var(--color-text-secondary);">unidades en stock</p>
          </div>
          <div class="bi-card kpi-card">
            <p class="text-sm font-medium" style="color: var(--color-text-secondary);">Ubicaciones Ocupadas</p>
            <p id="kpi-ubicaciones-ocupadas" class="text-3xl font-bold" style="color: var(--color-text);">${dashboardData.kpis.ubicacionesOcupadas}</p>
            <p id="kpi-ubicaciones-total" class="text-sm" style="color: var(--color-text-secondary);">de ${dashboardData.kpis.totalUbicaciones} disponibles</p>
          </div>
          <div class="bi-card kpi-card">
            <p class="text-sm font-medium" style="color: var(--color-text-secondary);">√ìrdenes Pendientes</p>
            <p id="kpi-ordenes-pendientes" class="text-3xl font-bold" style="color: var(--color-yellow-accent);">${dashboardData.kpis.ordenesPendientes}</p>
            <p class="text-sm" style="color: var(--color-text-secondary);">esperando producci√≥n</p>
          </div>
          <div class="bi-card kpi-card">
            <p class="text-sm font-medium" style="color: var(--color-text-secondary);">Tasa Cumplimiento</p>
            <p id="kpi-tasa-cumplimiento" class="text-3xl font-bold" style="color: var(--color-green-accent);">${dashboardData.kpis.tasaCumplimiento}%</p>
            <p class="text-sm" style="color: var(--color-text-secondary);">del d√≠a</p>
          </div>
          <div id="main-tendencia" class="bi-card tendencia-card grafico-card">
            <h3 class="font-semibold mb-4" style="color: var(--color-text);">Tendencia de Movimientos (√öltimos 7 d√≠as)</h3>
            <div class="h-64 lg:h-80 relative"><canvas id="tendenciaChart"></canvas></div>
          </div>
          <div id="main-estado-ordenes" class="bi-card estado-ordenes-card grafico-card">
            <h3 class="font-semibold mb-4" style="color: var(--color-text);">Estado de √ìrdenes de Fabricaci√≥n</h3>
            <div class="h-64 lg:h-80 relative"><canvas id="estadoOrdenesChart"></canvas></div>
          </div>
          <div id="panel-ordenes-fabricacion" class="bi-card ordenes-fabricacion-card">
            <h3 class="font-semibold mb-4" style="color: var(--color-text);">√ìrdenes de Fabricaci√≥n Activas (Top 5)</h3>
            <div id="ordenes-fabricacion-list" class="space-y-4"></div>
          </div>
          <div id="panel-stock-ubicacion" class="bi-card stock-ubicacion-card">
            <h3 class="font-semibold mb-4" style="color: var(--color-text);">Stock por Ubicaci√≥n (Top 5)</h3>
            <div id="stock-ubicacion-container" class="overflow-x-auto"></div>
          </div>
          <div id="main-actividad" class="bi-card actividad-card">
            <h3 class="font-semibold mb-4" style="color: var(--color-text);">Actividad Reciente (√öltimos 8)</h3>
            <div id="tabla-actividad-container" class="overflow-x-auto"></div>
          </div>
        </div>
      </div>
    `;
  }

  function renderEntrada() {
    return `
      <div class="card-minimal rounded-lg p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4 hidden md:block" style="color: var(--color-text);">Entrada de Inventario</h2>
        <div class="space-y-4">
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">C√≥digo de Pieza *</label>
            <div class="flex gap-2">
              <input type="text" id="entradaPieza" list="piezas-list" oninput="actualizarAlertaUbicaciones()" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="PIE-001">
              <button onclick="iniciarScanner('entradaPieza')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition" title="Escanear Pieza u Orden">QR</button>
            </div>
          </div>
          <div id="alertaUbicaciones"></div>
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Orden de Fabricaci√≥n</label>
            <div class="flex gap-2">
              <input type="text" id="entradaOrden" oninput="autocompletarPiezaDesdeOrden(this.value)" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="OF-2024-001">
              <button onclick="iniciarScanner('entradaOrden')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition" title="Escanear Orden">QR</button>
            </div>
            <p class="text-xs mt-1" style="color: var(--color-text-secondary);">Si es nueva, se pedir√° cantidad. Dejar vac√≠o para entrada sin orden.</p>
          </div>
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Ubicaci√≥n *</label>
            <div class="flex gap-2">
              <input type="text" id="entradaUbicacion" list="ubicaciones-list" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="M1-F3-C5">
              <button onclick="iniciarScanner('entradaUbicacion')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition" title="Escanear Ubicaci√≥n">QR</button>
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Cantidad *</label>
            <input type="number" id="entradaCantidad" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" min="1" placeholder="1">
          </div>
          <button onclick="procesarEntrada()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-medium transition">Registrar Entrada</button>
        </div>
      </div>
    `;
  }

  function renderSalida() {
    return `
      <div class="card-minimal rounded-lg p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4 hidden md:block" style="color: var(--color-text);">Salida de Inventario</h2>
        <div class="space-y-4">
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">C√≥digo de Pieza *</label>
            <div class="flex gap-2">
              <input type="text" id="salidaPieza" list="piezas-list" oninput="mostrarUbicacionesDisponibles()" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="PIE-001">
              <button onclick="iniciarScanner('salidaPieza')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition">QR</button>
            </div>
          </div>
          <div id="selectorOrden"></div>
          <div id="ubicacionesDisponibles"></div>
          <button onclick="procesarSalida()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition">Confirmar Salida</button>
        </div>
      </div>
    `;
  }

  function renderTraslados() {
    return `
      <div class="card-minimal rounded-lg p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4 hidden md:block" style="color: var(--color-text);">Traslados entre Ubicaciones</h2>
        <div id="paso1_traslado" class="space-y-4">
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">C√≥digo de Pieza *</label>
            <div class="flex gap-2">
              <input type="text" id="traslado_pieza" list="piezas-list" oninput="mostrarUbicacionesTraslado()" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="PIE-001">
              <button onclick="iniciarScanner('traslado_pieza')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition">QR</button>
            </div>
          </div>
          <div id="traslado_ubicaciones"></div>
        </div>
        <div id="paso2_traslado" class="hidden space-y-4">
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
            <p id="info_origen" class="text-sm font-medium text-purple-900"></p>
          </div>
          <input type="hidden" id="traslado_origen_hidden">
          <input type="hidden" id="traslado_disponible">
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Ubicaci√≥n Destino *</label>
            <div class="flex gap-2">
              <input type="text" id="traslado_destino" list="ubicaciones-list" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="M1-F5-C3">
              <button onclick="iniciarScanner('traslado_destino')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition">QR</button>
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Cantidad *</label>
            <input type="number" id="traslado_cantidad" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" min="1" placeholder="1">
          </div>
          <div class="flex gap-3">
            <button onclick="volverPaso1Traslado()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg font-medium transition">Volver</button>
            <button onclick="procesarTraslado()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium transition">Confirmar</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderBuscar() {
    return `
      <div class="card-minimal rounded-lg p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4 hidden md:block" style="color: var(--color-text);">Buscar en Inventario</h2>
        <div class="mb-4 flex gap-2">
          <button onclick="state.buscarPor='pieza'; renderContenido()" class="flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${state.buscarPor === 'pieza' ? 'bg-blue-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.buscarPor !== 'pieza' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Por Pieza</button>
          <button onclick="state.buscarPor='ubicacion'; renderContenido()" class="flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${state.buscarPor === 'ubicacion' ? 'bg-blue-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.buscarPor !== 'ubicacion' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Por Ubicaci√≥n</button>
        </div>
        <div class="space-y-4">
          ${state.buscarPor === 'pieza' ? `
            <div>
              <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">C√≥digo de Pieza</label>
              <div class="flex gap-2">
                <input type="text" id="busquedaPieza" list="piezas-list" oninput="buscarInventario()" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="PIE-001">
                <button onclick="iniciarScanner('busquedaPieza')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition">QR</button>
              </div>
            </div>
          ` : `
            <div>
              <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Ubicaci√≥n</label>
              <div class="flex gap-2">
                <input type="text" id="busquedaUbicacion" list="ubicaciones-list" oninput="buscarInventario()" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="M1-F3-C5">
                <button onclick="iniciarScanner('busquedaUbicacion')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm transition">QR</button>
              </div>
            </div>
          `}
          <div id="resultadosBusqueda" class="mt-4"><p class="text-center py-4 text-sm" style="color: var(--color-text-secondary);">Ingresa un t√©rmino de b√∫squeda</p></div>
        </div>
      </div>
    `;
  }

 function renderCatalogos() {
    const items = [...state.store.items].sort((a, b) => a.code.localeCompare(b.code));
    const locations = [...state.store.locations].sort((a, b) => a.qr.localeCompare(b.qr));
    const tabActiva = state.catalogoSubTab;

    return `
      <div class="card-minimal rounded-lg p-2 mb-4">
        <div class="flex gap-1">
          <button onclick="state.catalogoSubTab='piezas'; renderContenido()" 
            class="flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${tabActiva === 'piezas' ? 'bg-blue-600 text-white' : 'border hover:bg-gray-500/10'}" 
            style="${tabActiva !== 'piezas' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">
            üì¶ Piezas
          </button>
          <button onclick="state.catalogoSubTab='ubicaciones'; renderContenido()" 
            class="flex-1 py-2 px-4 rounded-lg font-medium text-sm transition ${tabActiva === 'ubicaciones' ? 'bg-blue-600 text-white' : 'border hover:bg-gray-500/10'}" 
            style="${tabActiva !== 'ubicaciones' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">
            üìç Ubicaciones
          </button>
        </div>
      </div>

      ${tabActiva === 'piezas' ? `
        <div class="space-y-6 fade-in">
          <h2 class="text-lg font-semibold" style="color: var(--color-text);">Cat√°logo de Piezas</h2>
          
          <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
             <p class="font-semibold text-blue-900 text-sm mb-1">Mantenimiento de Cat√°logo</p>
             <p class="text-xs text-blue-700">Usa "Ajuste" para poner el stock de una pieza err√≥nea en 0. Luego, ven aqu√≠ y "Arch√≠vala" para ocultarla de los men√∫s.</p>
          </div>
          
          <div class="card-minimal rounded-lg p-4 md:p-6">
            <h3 class="font-semibold text-base mb-3" style="color: var(--color-text);">Listado (${items.length} Piezas)</h3>
            <div class="space-y-2">
              ${items.map(item => `
                <div class="card-minimal rounded-lg p-3 flex justify-between items-center hover:bg-gray-500/10 transition ${item.status === 'archivado' ? 'opacity-50' : ''}">
                  <div class="flex-1 overflow-hidden">
                    <p class="font-semibold text-sm" style="color: var(--color-text);">${item.code}</p>
                    <p class="text-xs truncate" style="color: var(--color-text-secondary);">${item.description || 'Sin descripci√≥n'}</p>
                  </div>
                  <div class="flex items-center gap-2 ml-4">
                    ${item.status === 'archivado' ? `
                      <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200" style="color: var(--color-text-secondary);">Archivado</span>
                    ` : `
                      <button onclick="verificarArchivadoItem('${item.id}', '${item.code}')" class="bg-gray-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-medium hover:bg-gray-200 transition">
                        Gestionar
                      </button>
                    `}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      ` : ''}

      ${tabActiva === 'ubicaciones' ? `
        <div class="space-y-6 fade-in">
          <h2 class="text-lg font-semibold" style="color: var(--color-text);">Cat√°logo de Ubicaciones</h2>
          <div class="card-minimal rounded-lg p-4 md:p-6 space-y-4">
            <h3 class="font-semibold text-base" style="color: var(--color-text);">Crear/Editar Ubicaci√≥n</h3>
            <div>
              <label class="block mb-1 font-medium text-sm" style="color: var(--color-text);">C√≥digo QR / Ubicaci√≥n *</label>
              <input type="text" id="catalogo_location_qr" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Ej: M1-F1-C1">
              <p class="text-xs mt-1" style="color: var(--color-text-secondary);">El c√≥digo debe ser √∫nico.</p>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block mb-1 font-medium text-sm" style="color: var(--color-text);">M√≥dulo</label>
                <input type="text" id="catalogo_location_module" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Ej: M1">
              </div>
              <div>
                <label class="block mb-1 font-medium text-sm" style="color: var(--color-text);">Fila</label>
                <input type="text" id="catalogo_location_row" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Ej: F1">
              </div>
              <div>
                <label class="block mb-1 font-medium text-sm" style="color: var(--color-text);">Columna</label>
                <input type="text" id="catalogo_location_col" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Ej: C1">
              </div>
            </div>
            <input type="hidden" id="catalogo_location_id">
            <div class="flex gap-2">
              <button onclick="guardarLocation()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium text-sm transition">Guardar Ubicaci√≥n</button>
              <button onclick="limpiarFormularioCatalogo('location')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm transition">Limpiar</button>
            </div>
          </div>
          <div class="card-minimal rounded-lg p-4 md:p-6">
            <h3 class="font-semibold text-base mb-3" style="color: var(--color-text);">Listado (${locations.length} Ubicaciones)</h3>
            <div class="space-y-2">
              ${locations.map(loc => `
                <div class="card-minimal rounded-lg p-3 flex justify-between items-center hover:bg-gray-500/10 transition">
                  <div class="flex-1 overflow-hidden">
                    <p class="font-semibold text-sm" style="color: var(--color-text);">${loc.qr}</p>
                    <p class="text-xs truncate" style="color: var(--color-text-secondary);">${loc.module || 'M?'}-${loc.row || 'F?'}-${loc.col || 'C?'}</p>
                  </div>
                  <button onclick="editarLocation('${loc.id}')" class="bg-gray-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-medium ml-4 hover:bg-gray-200 transition">Editar</button>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      ` : ''}
    `;
  }

  function renderAjuste() {
    const selectedItemCode = state.ajustePieza || '';
    const selectedLocationQR = state.ajusteUbicacion || '';
    
    // Obtener el inventario por pieza y ubicaci√≥n para mostrar el stock actual
    const stockActual = Store.getInventory(state.store, selectedItemCode, selectedLocationQR);
    const totalStock = stockActual.reduce((sum, item) => sum + item.quantity, 0);

    return `
      <div class="card-minimal rounded-lg p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-4 hidden md:block" style="color: var(--color-text);">Ajuste de Inventario (Auditor√≠a)</h2>
        <div class="space-y-4">
          <div class="bg-amber-50 border-l-4 border-amber-500 rounded-lg p-4">
             <p class="font-semibold text-amber-900 text-sm mb-1">Advertencia de Auditor√≠a</p>
             <p class="text-xs text-amber-700">Esta acci√≥n modifica el inventario para reflejar la cantidad f√≠sica contada, registrando un movimiento de ajuste.</p>
          </div>
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">C√≥digo de Pieza *</label>
            <div class="flex gap-2">
              <input type="text" id="ajustePieza" list="piezas-list" value="${selectedItemCode}" onchange="state.ajustePieza = this.value.trim(); state.ajusteUbicacion = ''; renderContenido();" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="PIE-001">
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Ubicaci√≥n *</label>
            <div class="flex gap-2">
              <input type="text" id="ajusteUbicacion" list="ubicaciones-list" value="${selectedLocationQR}" onchange="state.ajusteUbicacion = this.value.trim(); renderContenido();" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="M1-F3-C5">
            </div>
            <p class="text-xs mt-1" style="color: var(--color-text-secondary);">El ajuste aplica solo al stock de esta pieza en esta ubicaci√≥n.</p>
          </div>

          ${selectedItemCode && selectedLocationQR ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm space-y-1">
              <p class="font-semibold text-blue-900">Stock actual en ${selectedLocationQR}:</p>
              <p class="text-xl font-bold text-blue-700">${totalStock} uds</p>
            </div>
            <div>
              <label class="block mb-2 font-medium text-sm" style="color: var(--color-text);">Cantidad Real Contada (Ajuste Final) *</label>
              <input type="number" id="ajusteCantidadContada" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" min="0" placeholder="0">
              <p class="text-xs mt-1" style="color: var(--color-text-secondary);">El inventario para ${selectedItemCode} en ${selectedLocationQR} se establecer√° a esta cantidad.</p>
            </div>
            <button onclick="procesarAjuste(${totalStock})" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-medium transition">Confirmar Ajuste</button>
          ` : `
            <div class="card-minimal rounded-lg p-8 text-center"><p class="text-sm" style="color: var(--color-text-secondary);">Selecciona Pieza y Ubicaci√≥n para continuar</p></div>
          `}
        </div>
      </div>
    `;
  }

  function renderOrdenes() {
    let ordenes = [...state.store.workOrders];
    if (state.ordenesSearchTerm) {
      const termino = state.ordenesSearchTerm.toLowerCase();
      ordenes = ordenes.filter(wo => 
        wo.code.toLowerCase().includes(termino) ||
        wo.itemCode.toLowerCase().includes(termino) ||
        (wo.description && wo.description.toLowerCase().includes(termino))
      );
    }
    if (state.ordenesFilter === 'activas') {
      ordenes = ordenes.filter(wo => wo.status === 'PENDIENTE');
    } else if (state.ordenesFilter === 'pendientes') {
      ordenes = ordenes.filter(wo => wo.status === 'ENVIO_PARCIAL');
    } else if (state.ordenesFilter === 'prod_completa') {
      ordenes = ordenes.filter(wo => wo.status === 'PRODUCCION_COMPLETA');
    } else if (state.ordenesFilter === 'completadas') {
      ordenes = ordenes.filter(wo => wo.status === 'COMPLETADA');
    } else if (state.ordenesFilter === 'sin_orden') {
      return renderPiezasSinOrden();
    }
    ordenes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    const getStatusColor = (status) => {
      switch(status) {
        case 'PENDIENTE': return 'border-l-amber-500 bg-amber-50';
        case 'PRODUCCION_COMPLETA': return 'border-l-blue-500 bg-blue-50';
        case 'ENVIO_PARCIAL': return 'border-l-orange-500 bg-orange-50';
        case 'COMPLETADA': return 'border-l-green-500 bg-green-50';
        default: return 'border-l-gray-500 bg-gray-50';
      }
    };
    const getStatusBadge = (status) => {
      switch(status) {
        case 'PENDIENTE': return 'bg-amber-100 text-amber-800';
        case 'PRODUCCION_COMPLETA': return 'bg-blue-100 text-blue-800';
        case 'ENVIO_PARCIAL': return 'bg-orange-100 text-orange-800';
        case 'COMPLETADA': return 'bg-green-100 text-green-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    };
    const getStatusText = (status) => {
      switch(status) {
        case 'PENDIENTE': return 'Pendiente';
        case 'PRODUCCION_COMPLETA': return 'Prod. Completa';
        case 'ENVIO_PARCIAL': return 'Env√≠o Parcial';
        case 'COMPLETADA': return 'Completada';
        default: return status;
      }
    };
    const getStockDisponible = (itemCode) => {
      const stock = Store.getInventory(state.store, itemCode);
      return stock.reduce((sum, item) => sum + item.quantity, 0);
    };
    const totalActivas = state.store.workOrders.filter(wo => wo.status === 'PENDIENTE').length;
    const totalPendientes = state.store.workOrders.filter(wo => wo.status === 'ENVIO_PARCIAL').length;
    const totalProdCompleta = state.store.workOrders.filter(wo => wo.status === 'PRODUCCION_COMPLETA').length;
    const totalCompletadas = state.store.workOrders.filter(wo => wo.status === 'COMPLETADA').length;
    const piezasSinOrden = getPiezasSinOrden(); // Se mantiene esta llamada aqu√≠ para contar
    return `
      <div class="space-y-4">
        <div class="card-minimal rounded-lg p-1 overflow-x-auto">
          <div class="flex gap-1 min-w-max">
            <button onclick="state.ordenesFilter='activas'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap ${state.ordenesFilter === 'activas' ? 'bg-amber-500 text-white' : 'border hover:bg-gray-500/10'}" style="${state.ordenesFilter !== 'activas' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Activas (${totalActivas})</button>
            <button onclick="state.ordenesFilter='pendientes'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap ${state.ordenesFilter === 'pendientes' ? 'bg-orange-500 text-white' : 'border hover:bg-gray-500/10'}" style="${state.ordenesFilter !== 'pendientes' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Pendientes (${totalPendientes})</button>
            <button onclick="state.ordenesFilter='prod_completa'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap ${state.ordenesFilter === 'prod_completa' ? 'bg-blue-500 text-white' : 'border hover:bg-gray-500/10'}" style="${state.ordenesFilter !== 'prod_completa' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Prod. Completa (${totalProdCompleta})</button>
            <button onclick="state.ordenesFilter='completadas'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap ${state.ordenesFilter === 'completadas' ? 'bg-green-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.ordenesFilter !== 'completadas' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Completadas (${totalCompletadas})</button>
            <button onclick="state.ordenesFilter='sin_orden'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap ${state.ordenesFilter === 'sin_orden' ? 'bg-gray-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.ordenesFilter !== 'sin_orden' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Sin Orden (${piezasSinOrden.length})</button>
          </div>
        </div>
        <div class="card-minimal rounded-lg p-4">
          <input type="text" value="${state.ordenesSearchTerm}" oninput="state.ordenesSearchTerm = this.value; renderContenido()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Buscar por c√≥digo de orden, pieza o descripci√≥n...">
        </div>
        ${ordenes.length === 0 ? `
          <div class="card-minimal rounded-lg p-8 text-center"><p class="text-sm" style="color: var(--color-text-secondary);">${state.ordenesSearchTerm ? 'No se encontraron resultados' : 'No hay √≥rdenes en esta categor√≠a'}</p></div>
        ` : `
          <div class="text-xs mb-2" style="color: var(--color-text-secondary);">${ordenes.length} orden(es)</div>
          <div class="space-y-3">
            ${ordenes.map(wo => {
              const pendienteProducir = wo.quantitySolicited - wo.quantityProduced;
              const pendienteEnviar = wo.quantitySolicited - wo.quantityShipped;
              const progresoProduccion = (wo.quantitySolicited > 0 ? (wo.quantityProduced / wo.quantitySolicited * 100) : 0).toFixed(0);
              const progresoEnvio = (wo.quantitySolicited > 0 ? (wo.quantityShipped / wo.quantitySolicited * 100) : 0).toFixed(0);
              const stockDisponible = getStockDisponible(wo.itemCode);
              return `
                <div class="card-minimal border-l-4 ${getStatusColor(wo.status)} rounded-lg p-4">
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                      <p class="font-semibold" style="color: var(--color-text);">${wo.code}</p>
                      <p class="text-sm" style="color: var(--color-text-secondary);">Pieza: <strong>${wo.itemCode}</strong></p>
                      ${wo.description ? `<p class="text-xs italic mt-1" style="color: var(--color-text-secondary);">${wo.description}</p>` : ''}
                    </div>
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(wo.status)}">${getStatusText(wo.status)}</span>
                  </div>
                  <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-white/70 rounded-md p-2" style="background-color: var(--color-bg);">
                      <p class="text-xs mb-1" style="color: var(--color-text-secondary);">Producci√≥n</p>
                      <div class="flex items-center gap-2 mb-1">
                        <div class="flex-1 bg-gray-200 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: ${progresoProduccion}%"></div></div>
                        <p class="text-xs font-semibold" style="color: var(--color-text);">${progresoProduccion}%</p>
                      </div>
                      <p class="text-xs" style="color: var(--color-text);"><strong>${wo.quantityProduced}</strong> / ${wo.quantitySolicited} ${pendienteProducir > 0 ? `<span class="text-amber-600">(- ${pendienteProducir})</span>` : ''}</p>
                    </div>
                    <div class="bg-white/70 rounded-md p-2" style="background-color: var(--color-bg);">
                      <p class="text-xs mb-1" style="color: var(--color-text-secondary);">Env√≠o</p>
                      <div class="flex items-center gap-2 mb-1">
                        <div class="flex-1 bg-gray-200 rounded-full h-1.5"><div class="bg-green-500 h-1.5 rounded-full transition-all" style="width: ${progresoEnvio}%"></div></div>
                        <p class="text-xs font-semibold" style="color: var(--color-text);">${progresoEnvio}%</p>
                      </div>
                      <p class="text-xs" style="color: var(--color-text);"><strong>${wo.quantityShipped}</strong> / ${wo.quantitySolicited} ${pendienteEnviar > 0 ? `<span class="text-red-600">(- ${pendienteEnviar})</span>` : ''}</p>
                    </div>
                  </div>
                  <div class="bg-white/70 rounded-md p-2 mb-3" style="background-color: var(--color-bg);">
                    <p class="text-xs" style="color: var(--color-text-secondary);">Stock Disponible</p>
                    <p class="text-base font-semibold ${stockDisponible > 0 ? 'text-green-700' : ''}" style="color: ${stockDisponible > 0 ? '' : 'var(--color-text-secondary)'};">${stockDisponible} uds</p>
                  </div>
                  <div class="flex gap-2">
                    ${wo.status !== 'COMPLETADA' && stockDisponible > 0 ? `
                      <button onclick="mostrarModalEnvio('${wo.code}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium text-sm transition">Enviar Stock</button>
                    ` : wo.status === 'COMPLETADA' ? `
                      <div class="flex-1 bg-green-100 text-green-700 py-2 rounded-lg font-medium text-center text-sm">Orden Completada</div>
                    ` : `
                      <div class="flex-1 bg-gray-100 py-2 rounded-lg font-medium text-center text-sm" style="color: var(--color-text-secondary);">Sin stock disponible</div>
                    `}

                    ${state.currentUser.role === 'admin' && wo.status !== 'COMPLETADA' ? `
                      <button onclick="confirmarEliminacionOrden('${wo.id}', '${wo.code}')" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg font-medium text-sm transition" title="Eliminar Orden">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                      </button>
                    ` : ''}
                  </div>
                  <p class="text-xs mt-2" style="color: var(--color-text-secondary);">Creada: ${new Date(wo.createdAt).toLocaleString('es-ES')} | ${wo.createdBy}</p>
                </div>
              `;
            }).join('')}
          </div>
        `}
      </div>
    `;
  }

  function renderPiezasSinOrden() {
    const piezasSinOrden = getPiezasSinOrden();
    const totalActivas = state.store.workOrders.filter(wo => wo.status === 'PENDIENTE').length;
    const totalPendientes = state.store.workOrders.filter(wo => wo.status === 'ENVIO_PARCIAL').length;
    const totalProdCompleta = state.store.workOrders.filter(wo => wo.status === 'PRODUCCION_COMPLETA').length;
    const totalCompletadas = state.store.workOrders.filter(wo => wo.status === 'COMPLETADA').length;
    return `
      <div class="space-y-4">
        <div class="card-minimal rounded-lg p-1 overflow-x-auto">
          <div class="flex gap-1 min-w-max">
            <button onclick="state.ordenesFilter='activas'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap border hover:bg-gray-500/10" style="color: var(--color-text); border-color: var(--color-border);">Activas (${totalActivas})</button>
            <button onclick="state.ordenesFilter='pendientes'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap border hover:bg-gray-500/10" style="color: var(--color-text); border-color: var(--color-border);">Pendientes (${totalPendientes})</button>
            <button onclick="state.ordenesFilter='prod_completa'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap border hover:bg-gray-500/10" style="color: var(--color-text); border-color: var(--color-border);">Prod. Completa (${totalProdCompleta})</button>
            <button onclick="state.ordenesFilter='completadas'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap border hover:bg-gray-500/10" style="color: var(--color-text); border-color: var(--color-border);">Completadas (${totalCompletadas})</button>
            <button onclick="state.ordenesFilter='sin_orden'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-xs transition whitespace-nowrap bg-gray-600 text-white">Sin Orden (${piezasSinOrden.length})</button>
          </div>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
          <p class="font-semibold text-blue-900 text-sm mb-1">Piezas Sin Orden de Fabricaci√≥n</p>
          <p class="text-xs text-blue-700">Stock disponible que no est√° vinculado a ninguna orden</p>
        </div>
        ${piezasSinOrden.length === 0 ? `
          <div class="card-minimal rounded-lg p-8 text-center"><p class="text-sm" style="color: var(--color-text-secondary);">No hay piezas sin orden</p></div>
        ` : `
          <div class="text-xs mb-2" style="color: var(--color-text-secondary);">${piezasSinOrden.length} pieza(s)</div>
          <div class="space-y-3">
            ${piezasSinOrden.map(pieza => `
              <div class="card-minimal border-l-4 border-gray-500 rounded-lg p-4">
                <div class="mb-3">
                  <p class="font-semibold" style="color: var(--color-text);">${pieza.itemCode}</p>
                  <p class="text-sm" style="color: var(--color-text-secondary);">Sin orden asignada</p>
                </div>
                <div class="bg-white/70 rounded-md p-2 mb-3" style="background-color: var(--color-bg);">
                  <p class="text-xs" style="color: var(--color-text-secondary);">Stock Total Sin Orden</p>
                  <p class="text-xl font-bold text-gray-700">${pieza.totalSinOrden} uds</p>
                </div>
                <div class="bg-white/70 rounded-md p-2" style="background-color: var(--color-bg);">
                  <p class="text-xs mb-2" style="color: var(--color-text-secondary);">Ubicaciones:</p>
                  ${pieza.ubicaciones.map(ub => `<p class="text-xs" style="color: var(--color-text);">${ub.locationQR}: ${ub.quantity} uds</p>`).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    `;
  }

  function renderHistorial() {
    const movimientos = obtenerHistorial();
    return `
      <div class="space-y-4">
        <div class="card-minimal rounded-lg p-4">
          <input type="text" value="${state.historialBusqueda}" oninput="state.historialBusqueda = this.value; renderContenido()" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm mb-3" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Buscar en historial...">
          <div class="grid grid-cols-3 gap-2">
            <button onclick="state.historialFiltro='general'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-sm transition ${state.historialFiltro === 'general' ? 'bg-blue-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.historialFiltro !== 'general' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Todos</button>
            <button onclick="state.historialFiltro='entradas'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-sm transition ${state.historialFiltro === 'entradas' ? 'bg-green-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.historialFiltro !== 'entradas' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Entradas</button>
            <button onclick="state.historialFiltro='salidas'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-sm transition ${state.historialFiltro === 'salidas' ? 'bg-red-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.historialFiltro !== 'salidas' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Salidas</button>
            <button onclick="state.historialFiltro='traslados'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-sm transition ${state.historialFiltro === 'traslados' ? 'bg-purple-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.historialFiltro !== 'traslados' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Traslados</button>
            
            <button onclick="state.historialFiltro='ajustes'; renderContenido()" class="py-2 px-3 rounded-lg font-medium text-sm transition ${state.historialFiltro === 'ajustes' ? 'bg-amber-600 text-white' : 'border hover:bg-gray-500/10'}" style="${state.historialFiltro !== 'ajustes' ? 'color: var(--color-text); border-color: var(--color-border);' : ''}">Ajustes</button>
          </div>
        </div>
        ${movimientos.length === 0 ? 
          `<div class="card-minimal rounded-lg p-6 text-center"><p class="text-sm" style="color: var(--color-text-secondary);">Sin movimientos</p></div>` 
          : 
          '<div class="space-y-2">' + movimientos.map(mov => {
            let borderColor = 'border-gray-300', bgColor = 'bg-white', tipoText = 'MOVIMIENTO', badgeColor = 'bg-gray-100 text-gray-700';
            if (mov.type === 'IN') { borderColor = 'border-green-200'; bgColor = 'bg-green-50'; tipoText = 'ENTRADA'; badgeColor = 'bg-green-100 text-green-700'; }
            else if (mov.type === 'OUT') { borderColor = 'border-red-200'; bgColor = 'bg-red-50'; tipoText = 'SALIDA'; badgeColor = 'bg-red-100 text-red-700'; }
            else if (mov.type === 'TRANSFER') { borderColor = 'border-purple-200'; bgColor = 'bg-purple-50'; tipoText = 'TRASLADO'; badgeColor = 'bg-purple-100 text-purple-700'; }
            // --- A√ëADIDO PARA AJUSTE ---
            else if (mov.type === 'ADJUST') { borderColor = 'border-amber-200'; bgColor = 'bg-amber-50'; tipoText = 'AJUSTE'; badgeColor = 'bg-amber-100 text-amber-700'; }
            
            // --- L√≥gica de Texto para AJUSTE ---
            let textoMovimiento = '';
            if (mov.type === 'IN') { textoMovimiento = `‚Üí ${mov.toLocationQR} | ${mov.quantity} uds`; }
            else if (mov.type === 'OUT') { textoMovimiento = `${mov.fromLocationQR} ‚Üí | ${mov.quantity} uds`; }
            else if (mov.type === 'TRANSFER') { textoMovimiento = `${mov.fromLocationQR} ‚Üí ${mov.toLocationQR} | ${mov.quantity} uds`; }
            // --- A√ëADIDO PARA AJUSTE ---
            else if (mov.type === 'ADJUST') { 
              const simbolo = mov.quantity > 0 ? '+' : '';
              const colorTextoCant = mov.quantity > 0 ? 'text-green-700' : 'text-red-700';
              textoMovimiento = `Ajuste en ${mov.toLocationQR} | <strong class="${colorTextoCant}">${simbolo}${mov.quantity} uds</strong>`;
            }

            return `
              <div class="card-minimal border-l-4 ${borderColor} ${bgColor} rounded-lg p-3 ${mov.edited ? 'ring-2 ring-amber-300' : ''}">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="px-2 py-0.5 ${badgeColor} text-xs font-medium rounded">${tipoText}</span>
                      <p class="font-semibold text-sm" style="color: var(--color-text);">${mov.itemCode}</p>
                    </div>
                    <p class="text-xs" style="color: var(--color-text-secondary);">${textoMovimiento}</p>
                    ${mov.workOrderCode ? `<p class="text-xs text-blue-700 font-medium">OF: ${mov.workOrderCode}</p>` : (mov.type !== 'ADJUST' ? '<p class="text-xs text-gray-500 font-medium">Sin orden</p>' : '')}
                    <p class="text-xs mt-1" style="color: var(--color-text-secondary);">${new Date(mov.createdAt).toLocaleString('es-ES')} | ${mov.createdBy}</p>
                    ${mov.edited ? `<p class="text-xs text-amber-700 font-semibold mt-1">Editado por ${mov.editedBy}</p>` : ''}
                  </div>
                  ${state.currentUser.role === 'admin' ? `
                    <button onclick="abrirModalEditarMovimiento('${mov.id}')" class="bg-amber-500 hover:bg-amber-600 text-white p-2 rounded-lg transition ml-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('') + '</div>'
        }
      </div>
    `;
  }

  function renderUsuarios() {
    const userList = Object.keys(state.store.users).map(username => ({ username, ...state.store.users[username] }));
    return `
      <div class="space-y-4">
        <div class="card-minimal rounded-lg p-4 md:p-6 bg-red-50 border-l-4 border-red-500">
          <p class="font-semibold text-red-900 mb-1 text-sm">FUNCI√ìN DESHABILITADA</p>
          <p class="text-xs text-red-700">La gesti√≥n de usuarios (creaci√≥n/eliminaci√≥n) se realiza ahora en Firebase Authentication. El listado de abajo es solo para referencia de roles internos, pero la creaci√≥n/eliminaci√≥n local no afecta a Firebase Auth.</p>
        </div>

        <div class="card-minimal rounded-lg p-4 md:p-6 hidden">
          <h3 class="font-semibold mb-3 text-sm" style="color: var(--color-text);">Agregar Nuevo Usuario (Deshabilitado)</h3>
          <div class="space-y-3">
            <input type="text" id="nuevoUsername" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Usuario (Email sin @erca.com)">
            <input type="password" id="nuevoPassword" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Contrase√±a">
            <input type="text" id="nuevoNombre" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);" placeholder="Nombre Completo">
            <select id="nuevoRole" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" style="background-color: var(--color-bg-card); color: var(--color-text); border-color: var(--color-border);">
              <option value="user">Usuario</option>
              <option value="admin">Administrador</option>
            </select>
            <button onclick="agregarUsuario()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium text-sm transition">Crear Usuario (D-H)</button>
          </div>
        </div>
        <h3 class="font-semibold text-sm" style="color: var(--color-text);">Usuarios Existentes (Roles Internos)</h3>
        <div class="space-y-2">
          ${userList.map(user => `
            <div class="card-minimal rounded-lg p-3 flex justify-between items-center">
              <div>
                <p class="font-semibold text-sm" style="color: var(--color-text);">${user.username}</p>
                <p class="text-xs" style="color: var(--color-text-secondary);">${user.nombre_completo}</p>
                <p class="text-xs" style="color: var(--color-text-secondary);">${user.role === 'admin' ? 'Administrador' : 'Operario'}</p>
              </div>
              <button onclick="eliminarUsuario('${user.username}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-sm transition" disabled>Eliminar (D-H)</button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  function getThemeColors() {
    const styles = getComputedStyle(document.documentElement);
    return {
      text: styles.getPropertyValue('--color-text').trim(),
      textSecondary: styles.getPropertyValue('--color-text-secondary').trim(),
      border: styles.getPropertyValue('--color-border').trim(),
      bgCard: styles.getPropertyValue('--color-bg-card').trim(),
      blueAccent: styles.getPropertyValue('--color-blue-accent').trim(),
      greenAccent: styles.getPropertyValue('--color-green-accent').trim(),
      redAccent: styles.getPropertyValue('--color-red-accent').trim(),
      yellowAccent: styles.getPropertyValue('--color-yellow-accent').trim(),
      purpleAccent: styles.getPropertyValue('--color-purple-accent').trim(),
    };
  }

  function mostrarFecha() {
    const dateEl = document.getElementById('current-date');
    if (!dateEl) return;
    const hoy = new Date();
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    let fechaStr = hoy.toLocaleDateString('es-ES', opciones);
    dateEl.textContent = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);
  }
  
  function llenarKPIs(kpis) {
    const kpiUnidades = document.getElementById('kpi-total-unidades');
    const kpiUbicaciones = document.getElementById('kpi-ubicaciones-ocupadas');
    const kpiUbicacionesTotal = document.getElementById('kpi-ubicaciones-total');
    const kpiPendientes = document.getElementById('kpi-ordenes-pendientes');
    const kpiTasa = document.getElementById('kpi-tasa-cumplimiento');

    if (kpiUnidades) kpiUnidades.textContent = kpis.totalUnidades;
    if (kpiUbicaciones) kpiUbicaciones.textContent = kpis.ubicacionesOcupadas;
    if (kpiUbicacionesTotal) kpiUbicacionesTotal.textContent = `de ${kpis.totalUbicaciones} disponibles`;
    if (kpiPendientes) kpiPendientes.textContent = kpis.ordenesPendientes;
    if (kpiTasa) kpiTasa.textContent = `${kpis.tasaCumplimiento}%`;
  }
  
  function renderActividadReciente(actividadData) {
    const container = document.getElementById('tabla-actividad-container');
    if (!container) return;
    if (actividadData.length === 0) {
      container.innerHTML = `<p class="text-sm text-center py-4" style="color: var(--color-text-secondary);">No hay actividad reciente.</p>`;
      return;
    }
    const filas = actividadData.map(mov => {
      let badgeClass = '';
      if (mov.tipo === 'IN') badgeClass = 'badge-in';
      else if (mov.tipo === 'OUT') badgeClass = 'badge-out';
      else if (mov.tipo === 'TRANSFER') badgeClass = 'badge-transfer';
      return `
        <tr>
          <td><span class="badge ${badgeClass}">${mov.tipo}</span></td>
          <td style="color: var(--color-text); font-weight: 500;">${mov.pieza}</td>
          <td style="color: var(--color-text);">${mov.cant} uds</td>
          <td style="color: var(--color-text-secondary);">${mov.ubic}</td>
          <td style="color: var(--color-text-secondary);">${mov.user}</td>
          <td style="color: var(--color-text-secondary);">${mov.time}</td>
        </tr>
      `;
    }).join('');
    container.innerHTML = `
      <table class="data-table">
        <thead>
          <tr>
            <th>Tipo</th> <th>Pieza</th> <th>Cantidad</th> <th>Ubicaci√≥n</th> <th>Usuario</th> <th>Hora</th>
          </tr>
        </thead>
        <tbody>${filas}</tbody>
      </table>
    `;
  }

  function renderOrdenesFabricacion(ordenesData) {
    const container = document.getElementById('ordenes-fabricacion-list');
    if (!container) return;
    if (ordenesData.length === 0) {
      container.innerHTML = `<p class="text-sm text-center py-4" style="color: var(--color-text-secondary);">No hay √≥rdenes activas.</p>`;
      return;
    }
    const items = ordenesData.map(orden => {
      let badgeClass = '';
      if (orden.estado === 'PENDIENTE') badgeClass = 'badge-pending';
      else if (orden.estado === 'PRODUCCION_COMPLETA') badgeClass = 'badge-partial';
      else if (orden.estado === 'ENVIO_PARCIAL') badgeClass = 'badge-transfer';
      const getStatusText = (status) => {
        switch(status) {
          case 'PENDIENTE': return 'Pendiente';
          case 'PRODUCCION_COMPLETA': return 'Prod. Completa';
          case 'ENVIO_PARCIAL': return 'Env√≠o Parcial';
          default: return status;
        }
      }
      return `
        <div class="flex items-center gap-3">
          <div class="w-20 text-sm font-medium" style="color: var(--color-text);">${orden.id}</div>
          <div class="flex-grow">
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs font-medium" style="color: var(--color-text-secondary);">${orden.pieza}</span>
              <span class="text-xs font-medium" style="color: var(--color-text-secondary);">${orden.progreso}%</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar" style="width: ${orden.progreso}%; background-color: ${orden.color};"></div>
            </div>
          </div>
          <span class="badge ${badgeClass}">${getStatusText(orden.estado)}</span>
        </div>
      `;
    }).join('');
    container.innerHTML = items;
  }

  function renderStockUbicacion(stockData) {
    const container = document.getElementById('stock-ubicacion-container');
    if (!container) return;
    if (stockData.length === 0) {
      container.innerHTML = `<p class="text-sm text-center py-4" style="color: var(--color-text-secondary);">No hay stock en ubicaciones.</p>`;
      return;
    }
    const filas = stockData.map(item => `
      <tr>
        <td style="color: var(--color-text); font-weight: 500;">${item.locationQR}</td>
        <td style="color: var(--color-text-secondary);">${item.piezasCount}</td>
        <td style="color: var(--color-text);">${item.totalUds}</td>
      </tr>
    `).join('');
    container.innerHTML = `
      <table class="data-table">
        <thead>
          <tr> <th>Ubicaci√≥n</th> <th>Piezas (Tipos)</th> <th>Total Uds</th> </tr>
        </thead>
        <tbody>${filas}</tbody>
      </table>
    `;
  }

  function initTendenciaChart(tendenciaData) {
    if (state.charts.tendencia) state.charts.tendencia.destroy();
    const ctx = document.getElementById('tendenciaChart')?.getContext('2d');
    if (!ctx) return;
    const colors = getThemeColors();
    const gradientEntradas = ctx.createLinearGradient(0, 0, 0, 400);
    gradientEntradas.addColorStop(0, 'rgba(74, 222, 128, 0.5)');
    gradientEntradas.addColorStop(1, 'rgba(74, 222, 128, 0)');
    const gradientSalidas = ctx.createLinearGradient(0, 0, 0, 400);
    gradientSalidas.addColorStop(0, 'rgba(248, 113, 113, 0.5)');
    gradientSalidas.addColorStop(1, 'rgba(248, 113, 113, 0)');
    state.charts.tendencia = new Chart(ctx, {
      type: 'line',
      data: {
        labels: tendenciaData.labels,
        datasets: [
          { label: 'Entradas', data: tendenciaData.entradas, borderColor: colors.greenAccent, backgroundColor: gradientEntradas, fill: true, tension: 0.3 },
          { label: 'Salidas', data: tendenciaData.salidas, borderColor: colors.redAccent, backgroundColor: gradientSalidas, fill: true, tension: 0.3 }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { color: colors.textSecondary }, grid: { color: colors.border } },
          x: { ticks: { color: colors.textSecondary }, grid: { color: 'transparent' } }
        },
        plugins: { legend: { labels: { color: colors.text } } }
      }
    });
  }

  function initEstadoOrdenesChart(estadoOrdenesData) {
    if (state.charts.estadoOrdenes) state.charts.estadoOrdenes.destroy();
    const ctx = document.getElementById('estadoOrdenesChart')?.getContext('2d');
    if (!ctx) return;
    const colors = getThemeColors();
    state.charts.estadoOrdenes = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: estadoOrdenesData.labels,
        datasets: [{
          label: 'N¬∫ de √ìrdenes',
          data: estadoOrdenesData.cantidades,
          backgroundColor: [
            'rgba(251, 146, 60, 0.7)', 'rgba(59, 130, 246, 0.7)',
            'rgba(167, 139, 250, 0.7)', 'rgba(74, 222, 128, 0.7)'
          ],
          borderColor: [
            colors.yellowAccent, colors.blueAccent, colors.purpleAccent, colors.greenAccent
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
        scales: {
          y: { ticks: { color: colors.textSecondary }, grid: { color: 'transparent' } },
          x: { ticks: { color: colors.textSecondary }, grid: { color: colors.border } }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  function actualizarColoresGraficos() {
    const colors = getThemeColors();
    if (state.charts.tendencia) {
      try {
        state.charts.tendencia.data.datasets[0].borderColor = colors.greenAccent;
        state.charts.tendencia.data.datasets[1].borderColor = colors.redAccent;
        state.charts.tendencia.options.scales.y.ticks.color = colors.textSecondary;
        state.charts.tendencia.options.scales.y.grid.color = colors.border;
        state.charts.tendencia.options.scales.x.ticks.color = colors.textSecondary;
        state.charts.tendencia.options.plugins.legend.labels.color = colors.text;
        state.charts.tendencia.update('none');
      } catch(e) { console.error("Error actualizando chart tendencia:", e); }
    }
    if (state.charts.estadoOrdenes) {
      try {
        state.charts.estadoOrdenes.data.datasets[0].borderColor = [
              colors.yellowAccent, colors.blueAccent, colors.purpleAccent, colors.greenAccent
            ];
        state.charts.estadoOrdenes.options.scales.y.ticks.color = colors.textSecondary;
        state.charts.estadoOrdenes.options.scales.x.ticks.color = colors.textSecondary;
        state.charts.estadoOrdenes.options.scales.x.grid.color = colors.border;
        state.charts.estadoOrdenes.update('none');
      } catch(e) { console.error("Error actualizando chart ordenes:", e); }
    }
  }

  // Se a√±aden stubs para funciones del Admin avanzado (Fase 4)
  function abrirModalEditarMovimiento(movementId) {
    const movement = state.store.movements.find(m => m.id === movementId);
    if (!movement) {
        showCustomAlert('‚ùå Error', 'Movimiento no encontrado en el historial local.');
        return;
    }
    // Restricci√≥n para no editar AJUSTE (es m√°s complejo, se recomienda hacer un AJUSTE nuevo)
    if (movement.type === 'ADJUST') {
        showCustomAlert('‚ùå Funci√≥n Restringida', 'Los movimientos de AJUSTE solo pueden corregirse con un nuevo movimiento de AJUSTE. No se permite editar la diferencia original.');
        return;
    }
    
    // Configurar el estado para el modal
    state.editingMovement = movement;
    
    // Forzar el re-render del contenedor de modales
    renderModalsContainer();

    // Habilitar el bot√≥n Guardar y establecer el valor actual
    setTimeout(() => {
        const modal = document.getElementById('editMovementModal');
        const quantityInput = document.getElementById('edit_movement_quantity');
        
        // El bot√≥n ya no est√° disabled en el HTML
        if (quantityInput) quantityInput.value = movement.quantity;
    }, 100);
  }
  
  function cerrarModalEditarMovimiento() {
    state.editingMovement = null;
    renderModalsContainer(); 
  }
  
  async function guardarEdicionMovimiento() {
    const movementId = document.getElementById('edit_movement_id').value;
    const newQuantity = parseInt(document.getElementById('edit_movement_quantity').value);
    
    if (isNaN(newQuantity) || newQuantity < 0) { // <-- Correcci√≥n para permitir 0
        showCustomAlert('‚ö†Ô∏è Advertencia', 'La cantidad no puede ser negativa.'); 
        return;
    }
    
    const originalQuantity = state.editingMovement.quantity;
    const movementType = state.editingMovement.type;
    
    const confirmacion = confirm(`Est√°s a punto de cambiar la cantidad del movimiento de ${originalQuantity} a ${newQuantity} uds (${movementType}).\n\nEsta acci√≥n modificar√° el inventario afectado y la Work Order correspondiente.\n\n¬øConfirmas la edici√≥n?`);
    
    if (!confirmacion) return;

    showLoader(); // <-- ENCENDER
    try {
        await Store.editMovement(movementId, newQuantity);
        
        showCustomAlert('‚úÖ Edici√≥n Exitosa', `Movimiento ${movementId} editado de ${originalQuantity} a ${newQuantity} uds.`);
        
        cerrarModalEditarMovimiento();
        actualizarUIDesdeMovimiento(); // Refrescar Historial y Dashboard
        renderContenido(); // Forzar re-render de la pesta√±a actual (Historial)

    } catch(e) {
        console.error("Error al guardar edici√≥n de movimiento:", e);
        showCustomAlert('‚ùå Error de Transacci√≥n', `Error al editar el movimiento: ${e.message}`);
    } finally {
        hideLoader(); // <-- APAGAR
    }
  }

// =========================================================================
  // IMPLEMENTACI√ìN DE FUNCIONES DE ADMIN (Cat√°logos y Ajuste)
  // =========================================================================

  /**
   * 1. Procesa el Ajuste de Inventario (Pesta√±a "Ajuste")
   */
  async function procesarAjuste(stockActual) {
    const pieza = document.getElementById('ajustePieza').value.trim();
    const ubicacion = document.getElementById('ajusteUbicacion').value.trim();
    const cantidadContadaInput = document.getElementById('ajusteCantidadContada');
    const cantidadContada = parseInt(cantidadContadaInput.value);

    if (isNaN(cantidadContada) || cantidadContada < 0) {
      showCustomAlert('‚ö†Ô∏è Advertencia', 'La cantidad contada debe ser 0 o un n√∫mero positivo.');
      return;
    }
    
    const diferencia = cantidadContada - stockActual;
    
    if (diferencia === 0) {
        showCustomAlert('‚ÑπÔ∏è Informaci√≥n', 'La cantidad contada es igual al stock actual. No se requiere ajuste.');
        return;
    }

    const simbolo = diferencia > 0 ? '+' : '';
    const confirmacion = confirm(
      `Confirmas el ajuste para:\n` +
      `Pieza: ${pieza}\n` +
      `Ubicaci√≥n: ${ubicacion}\n\n` +
      `Stock Actual: ${stockActual} uds\n` +
      `Conteo F√≠sico: ${cantidadContada} uds\n\n` +
      `Se registrar√° un movimiento de AJUSTE por: ${simbolo}${diferencia} uds.\n` +
      `¬øEs esto correcto?`
    );
    
    if (!confirmacion) return;

    showLoader();
    try {
      await Store.adjustStock(pieza, ubicacion, cantidadContada);
      
      showCustomAlert('‚úÖ Ajuste Exitoso', `El stock de ${pieza} en ${ubicacion} se ajust√≥ a ${cantidadContada} uds (Diferencia: ${simbolo}${diferencia}).`);
      
      // Limpiar y resetear la pesta√±a de ajuste
      state.ajustePieza = '';
      state.ajusteUbicacion = '';
      renderContenido(); // Re-renderiza la pesta√±a de ajuste
      actualizarUIDesdeMovimiento(); // Actualiza el dashboard

    } catch (e) {
      console.error("Error al procesar ajuste:", e);
      showCustomAlert('‚ùå Error de Transacci√≥n', `Error al procesar el ajuste: ${e.message}`);
    } finally {
      hideLoader();
    }
  }

/**
   * 2. Verifica una Pieza antes de Archivarla (Pesta√±a "Cat√°logos")
   */
  async function verificarArchivadoItem(itemId, itemCode) {
    state.verificandoItemData = null; // Renombramos 'showVerificarItemModal' a 'showGestionarItemModal'
    state.showGestionarItemModal = true;
    renderModalsContainer();

    const item = state.store.items.find(i => i.id === itemId);
    if (!item) {
        showCustomAlert('‚ùå Error', 'Pieza no encontrada en el store local.');
        cerrarModalGestionarItem();
        return;
    }

    // 1. Contar Stock (del store local)
    const stock = state.store.inventory
      .filter(inv => inv.itemId === itemId)
      .reduce((sum, inv) => sum + inv.quantity, 0);
    
    // (Ya no necesitamos contar historial ni √≥rdenes)
    
    const isSafeToArchive = (stock === 0);

    state.verificandoItemData = { 
        itemId, 
        itemCode, 
        stock, 
        status: item.status || 'activo',
        isSafeToArchive 
    };
    renderModalsContainer(); // Volver a renderizar el modal con los datos
  }

  function cerrarModalGestionarItem() { // Renombrada
    state.showGestionarItemModal = false;
    state.verificandoItemData = null;
    renderModalsContainer();
  }

  async function confirmarArchivadoItem() { // Renombrada
    const { itemId, itemCode } = state.verificandoItemData;

    showLoader();
    try {
      await Store.archiveItem(itemId, itemCode); // ¬°Llama a la nueva funci√≥n del Store!
      showCustomAlert('‚úÖ √âxito', `La pieza ${itemCode} ha sido archivada y se ocultar√° de los men√∫s.`);
      cerrarModalGestionarItem();
      // El 'listener' de Firestore actualizar√° la lista autom√°ticamente
    } catch (e) {
      console.error("Error al archivar pieza:", e);
      showCustomAlert('‚ùå Error al Archivar', `Error: ${e.message}`);
    } finally {
      hideLoader();
    }
  }

  async function confirmarEliminacionOrden(workOrderId, workOrderCode) {
    const confirmacion = confirm(`¬øEst√°s seguro de que quieres eliminar la Orden ${workOrderCode}?\n\n¬°ADVERTENCIA!\nEsta acci√≥n es irreversible.\n\nSolo deber√≠as hacer esto si la orden est√° "limpia" (Producci√≥n = 0 y Env√≠os = 0). Si no lo est√°, la eliminaci√≥n fallar√°.`);
    
    if (!confirmacion) return;

    showLoader();
    try {
      await Store.deleteWorkOrder(workOrderId, workOrderCode);
      showCustomAlert('‚úÖ √âxito', `La Orden ${workOrderCode} ha sido eliminada.`);
      // El 'listener' de Firestore actualizar√° la lista autom√°ticamente
    } catch (e) {
      console.error("Error al eliminar orden:", e);
      showCustomAlert('‚ùå Error al Eliminar', `Error: ${e.message}`);
    } finally {
      hideLoader();
    }
  }
  
  /**
   * 3. Guarda o Edita una Ubicaci√≥n (Pesta√±a "Cat√°logos")
   */
  async function guardarLocation() {
    const id = document.getElementById('catalogo_location_id').value;
    const qr = document.getElementById('catalogo_location_qr').value.trim();
    const module = document.getElementById('catalogo_location_module').value.trim();
    const row = document.getElementById('catalogo_location_row').value.trim();
    const col = document.getElementById('catalogo_location_col').value.trim();

    if (!qr) {
      showCustomAlert('‚ö†Ô∏è Advertencia', 'El C√≥digo QR / Ubicaci√≥n es obligatorio.');
      return;
    }

    showLoader();
    try {
      await Store.saveLocation(id || null, qr, module, row, col);
      showCustomAlert('‚úÖ √âxito', `Ubicaci√≥n ${qr} guardada correctamente.`);
      
      limpiarFormularioCatalogo('location');
      // No necesitamos 'renderContenido' aqu√≠ tampoco.

    } catch (e) {
      console.error("Error al guardar location:", e);
      showCustomAlert('‚ùå Error al Guardar', `Error al guardar la ubicaci√≥n: ${e.message}`);
    } finally {
      hideLoader();
    }
  }

  // --- Funciones auxiliares para los nuevos formularios ---

  function limpiarFormularioCatalogo(tipo) {
    // La parte de 'item' ya no es necesaria, pero la dejamos por si 'location' la usa
    if (tipo === 'item') {
      // (vacio)
    } else if (tipo === 'location') {
      document.getElementById('catalogo_location_id').value = '';
      document.getElementById('catalogo_location_qr').value = '';
      document.getElementById('catalogo_location_module').value = '';
      document.getElementById('catalogo_location_row').value = '';
      document.getElementById('catalogo_location_col').value = '';
    }
  }

  // La funci√≥n editarItem ya no se usa

  function editarLocation(id) {
    const loc = state.store.locations.find(l => l.id === id);
    if (!loc) return;
    document.getElementById('catalogo_location_id').value = loc.id;
    document.getElementById('catalogo_location_qr').value = loc.qr;
    document.getElementById('catalogo_location_module').value = loc.module;
    document.getElementById('catalogo_location_row').value = loc.row;
    document.getElementById('catalogo_location_col').value = loc.col;
    window.scrollTo(0, 0); // Sube al inicio de la p√°gina para ver el formulario
  }
  
  // --- Ejecuci√≥n Inicial ---
  aplicarTema(); 
  buildStoreMaps(state.store); 
  render();
  </script>
</body>
</html>
